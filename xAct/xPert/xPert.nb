Notebook[{

Cell[CellGroupData[{
Cell[TextData[StyleBox["xPert",
 FontSlant->"Italic",
 FontColor->RGBColor[1, 0, 0]]], "Title"],

Cell[TextData[StyleBox["High-order perturbation theory in General Relativity",
 
 FontColor->RGBColor[0, 0, 1]]], "Subtitle"],

Cell[TextData[{
 "David Brizuela, Jos\[EAcute] M. Mart\[IAcute]n-Garc\[IAcute]a and Guillermo \
A. Mena Marug\[AAcute]n\n",
 StyleBox["Instituto de Estructura de la Materia, CSIC, Madrid\n\n(c) \
2005-2015, under GPL\n\njose@xact.es\n\nhttp://www.xact.es/\n\n\
http://groups.google.com/group/xact",
  FontSize->16],
 "\n\n",
 StyleBox["October 2005 - May 2006: Version 0.5.0: First public version.",
  FontSize->12],
 "\n",
 StyleBox["September 2007: Version 0.7.0: Notebook adapted for version 0.9.2 \
of xAct.\nNovember 2007: Version 0.7.1: Notebook adapted for version 0.9.3 of \
xAct.\nMarch 2008: Version 0.7.2: Notebook adapted for version 0.9.4 of xAct.\
\nMay-June 2008: Version 1.0.0. Substantial update for publication.",
  FontSize->12]
}], "Subsubtitle",
 FontSize->18],

Cell[TextData[{
 "This package expands any finite-order perturbation of any of the \
GR-relevant curvature tensors in terms of metric perturbations.\n\nThe \
package ",
 StyleBox["xPert",
  FontSlant->"Italic",
  FontColor->RGBColor[1, 0, 0]],
 " is distributed under the GNU GPL License, and runs on top of ",
 StyleBox["xTensor",
  FontSlant->"Italic",
  FontColor->RGBColor[0, 0, 1]],
 ", a free package for fast manipulation of abstract tensor expressions in ",
 StyleBox["Mathematica",
  FontSlant->"Italic"],
 "."
}], "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"DateList", "[", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
  "2015", ",", "8", ",", "19", ",", "2", ",", "45", ",", 
   "10.77339`7.784927368155277"}], "}"}]], "Output"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"xAct`xPert`$Version", "=", 
   RowBox[{"{", 
    RowBox[{"\"\<1.0.5\>\"", ",", 
     RowBox[{"{", 
      RowBox[{"2014", ",", "9", ",", "28"}], "}"}]}], "}"}]}], ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{"xAct`xPert`$xTensorVersionExpected", "=", 
   RowBox[{"{", 
    RowBox[{"\"\<1.1.1\>\"", ",", 
     RowBox[{"{", 
      RowBox[{"2014", ",", "9", ",", "28"}], "}"}]}], "}"}]}], ";"}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[TextData[StyleBox["1. Initialization",
 FontColor->RGBColor[0, 0, 1]]], "Subsection"],

Cell[CellGroupData[{

Cell["1.1. GPL", "Subsubsection"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{"xPert", ",", " ", 
    RowBox[{
    "computer", " ", "algebra", " ", "for", " ", "perturbation", " ", 
     "theory", " ", "in", " ", "General", " ", "Relativity"}]}], " ", "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"Copyright", " ", 
      RowBox[{"(", "C", ")"}], " ", "2005"}], "-", 
     RowBox[{"2014", " ", "David", " ", "Brizuela"}]}], ",", " ", 
    RowBox[{
     RowBox[{"Jose", " ", 
      RowBox[{"M", ".", " ", "Martin"}]}], "-", 
     RowBox[{"Garcia", " ", "and", " ", "Guillermo", " ", 
      RowBox[{"A", ".", " ", "Mena"}], " ", "Marugan"}]}]}], " ", "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{
     "This", " ", "program", " ", "is", " ", "free", " ", "software"}], ";", 
     " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], "\[IndentingNewLine]", " ", "modify", " ", 
      "it", " ", "under", " ", "the", " ", "terms", " ", "of", " ", "the", 
      " ", "GNU", " ", "General", " ", "Public", " ", "License", " ", "as", 
      "\[IndentingNewLine]", " ", "published", " ", "by", " ", "the", " ", 
      "Free", " ", "Software", " ", "Foundation"}], ";", " ", 
     RowBox[{
     "either", " ", "version", " ", "2", " ", "of", "\[IndentingNewLine]", 
      " ", "the", " ", "License"}]}], ",", 
    RowBox[{"or", " ", 
     RowBox[{"(", 
      RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
     "later", " ", 
     RowBox[{
     "version", ".", "\[IndentingNewLine]", "\[IndentingNewLine]", "This"}], 
     " ", "program", " ", "is", " ", "distributed", " ", "in", " ", "the", 
     " ", "hope", " ", "that", " ", "it", " ", "will", " ", "be", " ", 
     "useful"}], ",", "\[IndentingNewLine]", "  ", 
    RowBox[{
     RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
     RowBox[{
     "without", " ", "even", " ", "the", " ", "implied", " ", "warranty", " ",
       "of", "\[IndentingNewLine]", " ", "MERCHANTABILITY", " ", "or", " ", 
      "FITNESS", " ", "FOR", " ", "A", " ", "PARTICULAR", " ", 
      RowBox[{"PURPOSE", ".", " ", "See"}], " ", "the", " ", "GNU", 
      "\[IndentingNewLine]", " ", "General", " ", "Public", " ", "License", 
      " ", "for", " ", "more", " ", 
      RowBox[{
      "details", ".", "\[IndentingNewLine]", "\[IndentingNewLine]", "You"}], 
      " ", "should", " ", "have", " ", "received", " ", "a", " ", "copy", " ",
       "of", " ", "the", " ", "GNU", " ", "General", " ", "Public", " ", 
      "License", "\[IndentingNewLine]", " ", "along", " ", "with", " ", 
      "this", " ", "program"}], ";", " ", 
     RowBox[{"if", " ", "not"}]}], ",", " ", 
    RowBox[{
    "write", " ", "to", " ", "the", " ", "Free", " ", "Software", 
     "\[IndentingNewLine]", " ", "Foundation"}], ",", " ", 
    RowBox[{"Inc", "."}], ",", " ", 
    RowBox[{
     RowBox[{"59", " ", "Temple", " ", "Place"}], "-", 
     RowBox[{"Suite", " ", "330"}]}], ",", " ", "Boston", ",", " ", 
    RowBox[{
     RowBox[{"MA", " ", "02111"}], "-", "1307"}], ",", "\[IndentingNewLine]", 
    "  ", 
    RowBox[{"USA", "."}]}], " ", "\[IndentingNewLine]", "*)"}]}]], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["1.2. Info package", "Subsubsection"],

Cell["\<\
(* :Title: xPert *)

(* :Author: David Brizuela, Jose M. Martin-Garcia and 
\tGuillermo A. Mena Marugan *)

(* :Summary: Computer algebra for perturbation theory in General
    Relativity *)

(* :Brief Discussion:
   - Single-parameter metric perturbation theory
   - Inert-head Perturbation and explicit expansion formulas
     through ExpandPerturbation
   - Handles densities, derivatives and all index positions in
     tensors
   - Formula for arbitrary gauge change 
*)
  
(* :Context: xAct`xPert` *)

(* :Package Version: 1.0.5 *)

(* :Copyright: David Brizuela, Jose M. Martin-Garcia and 
\tGuillermo A. Mena Marugan (2005-2015) *)

(* :History: see xPert.History *)

(* :Keywords: *)

(* :Source: xPert.nb *)

(* :Warning: ToCanonical can only act on expressions with the
    Perturbation head with option UseMetricOnVBundle->None *)

(* :Mathematica Version: 6.0 and later *)

(* :Limitations: 
\t- Only one perturbation structure can be defined.
\t- Only single-parameter metric perturbation theory *)\
\>", "Input",
 PageWidth->PaperWidth,
 CellMargins->{{60, -272}, {Inherited, Inherited}},
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["1.3. BeginPackage", "Subsubsection"],

Cell["Protect against multiple loading of the package:", "Text"],

Cell[BoxData[
 RowBox[{"With", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"xAct`xPert`Private`xPertSymbols", "=", 
     RowBox[{"DeleteCases", "[", 
      RowBox[{
       RowBox[{"Join", "[", 
        RowBox[{
         RowBox[{"Names", "[", "\"\<xAct`xPert`*\>\"", "]"}], ",", 
         RowBox[{"Names", "[", "\"\<xAct`xPert`Private`*\>\"", "]"}]}], "]"}],
        ",", 
       RowBox[{
       "\"\<$Version\>\"", "|", "\"\<xAct`xPert`$Version\>\"", "|", 
        "\"\<$xTensorVersionExpected\>\"", "|", 
        "\"\<xAct`xPert`$xTensorVersionExpected\>\""}]}], "]"}]}], "}"}], ",",
    "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Unprotect", "/@", "xAct`xPert`Private`xPertSymbols"}], ";", 
    "\[IndentingNewLine]", 
    RowBox[{"Clear", "/@", "xAct`xPert`Private`xPertSymbols"}], ";"}]}], 
  "\[IndentingNewLine]", "]"}]], "Input",
 InitializationCell->True],

Cell["Decide which is the last package being read:", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"Unevaluated", "[", "xAct`xCore`Private`$LastPackage", "]"}], "===",
      "xAct`xCore`Private`$LastPackage"}], ",", 
    RowBox[{"xAct`xCore`Private`$LastPackage", "=", "\"\<xAct`xPert`\>\""}]}],
    "]"}], ";"}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData["xAct`xCore`Private`$LastPackage"], "Input"],

Cell[BoxData["\<\"xAct`xPert`\"\>"], "Output"]
}, Open  ]],

Cell["\<\
Explicit (not hidden) import of other packages. QUESTION: Do we really need \
ExpressionManipulation?\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"BeginPackage", "[", 
  RowBox[{"\"\<xAct`xPert`\>\"", ",", 
   RowBox[{"{", 
    RowBox[{
    "\"\<xAct`xTensor`\>\"", ",", "\"\<xAct`xPerm`\>\"", ",", 
     "\"\<xAct`xCore`\>\"", ",", "\"\<xAct`ExpressionManipulation`\>\""}], 
    "}"}]}], "]"}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"Package xAct`xPerm`  version \"\>", 
   "\[InvisibleSpace]", "\<\"1.2.3\"\>", "\[InvisibleSpace]", "\<\", \"\>", 
   "\[InvisibleSpace]", 
   RowBox[{"{", 
    RowBox[{"2015", ",", "8", ",", "23"}], "}"}]}],
  SequenceForm["Package xAct`xPerm`  version ", "1.2.3", ", ", {2015, 8, 23}],
  
  Editable->False]], "Print"],

Cell[BoxData["\<\"CopyRight (C) 2003-2015, Jose M. Martin-Garcia, under the \
General Public License.\"\>"], "Print"],

Cell[BoxData["\<\"Connecting to external mac executable...\"\>"], "Print"],

Cell[BoxData["\<\"Connection established.\"\>"], "Print"],

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"Package xAct`xTensor`  version \"\>", 
   "\[InvisibleSpace]", "\<\"1.1.2\"\>", "\[InvisibleSpace]", "\<\", \"\>", 
   "\[InvisibleSpace]", 
   RowBox[{"{", 
    RowBox[{"2015", ",", "8", ",", "23"}], "}"}]}],
  SequenceForm[
  "Package xAct`xTensor`  version ", "1.1.2", ", ", {2015, 8, 23}],
  Editable->False]], "Print"],

Cell[BoxData["\<\"CopyRight (C) 2002-2015, Jose M. Martin-Garcia, under the \
General Public License.\"\>"], "Print"]
}, Open  ]],

Cell[BoxData["\<\"xAct`xPert`\"\>"], "Output"]
}, Open  ]],

Cell[TextData[{
 "Check version of ",
 StyleBox["xTensor",
  FontSlant->"Italic"],
 ". We simply compare dates:"
}], "Text"],

Cell[BoxData[
 RowBox[{"If", "[", 
  RowBox[{
   RowBox[{"Not", "@", 
    RowBox[{"OrderedQ", "@", 
     RowBox[{"Map", "[", 
      RowBox[{"Last", ",", 
       RowBox[{"{", 
        RowBox[{"$xTensorVersionExpected", ",", "xAct`xTensor`$Version"}], 
        "}"}]}], "]"}]}]}], ",", 
   RowBox[{"Throw", "@", 
    RowBox[{"Message", "[", 
     RowBox[{
      RowBox[{"General", "::", "versions"}], ",", "\"\<xTensor\>\"", ",", 
      "xAct`xTensor`$Version", ",", "$xTensorVersionExpected"}], "]"}]}]}], 
  "]"}]], "Input",
 InitializationCell->True],

Cell["Welcome message:", "Text"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"Print", "[", "xAct`xCore`Private`bars", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Print", "[", 
   RowBox[{"\"\<Package xAct`xPert`  version \>\"", ",", 
    RowBox[{"$Version", "[", 
     RowBox[{"[", "1", "]"}], "]"}], ",", "\"\<, \>\"", ",", 
    RowBox[{"$Version", "[", 
     RowBox[{"[", "2", "]"}], "]"}]}], "]"}], ";"}], "\n", 
 RowBox[{
  RowBox[{
  "Print", "[", 
   "\"\<CopyRight (C) 2005-2015, David Brizuela, Jose M. Martin-Garcia and \
Guillermo A. Mena Marugan, under the General Public License.\>\"", "]"}], 
  ";"}]}], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"Package xAct`xPert`  version \"\>", 
   "\[InvisibleSpace]", "\<\"1.0.5\"\>", "\[InvisibleSpace]", "\<\", \"\>", 
   "\[InvisibleSpace]", 
   RowBox[{"{", 
    RowBox[{"2014", ",", "9", ",", "28"}], "}"}]}],
  SequenceForm["Package xAct`xPert`  version ", "1.0.5", ", ", {2014, 9, 28}],
  
  Editable->False]], "Print"],

Cell[BoxData["\<\"CopyRight (C) 2005-2015, David Brizuela, Jose M. \
Martin-Garcia and Guillermo A. Mena Marugan, under the General Public \
License.\"\>"], "Print"]
}, Open  ]]
}, Open  ]],

Cell["\<\
We specify the context xAct`xPert` to avoid overriding the Disclaimer of the \
other packages. However we need to turn off the message General:shdw \
temporarily:\
\>", "Text"],

Cell[BoxData[{
 RowBox[{"Off", "[", 
  RowBox[{"General", "::", "shdw"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"xAct`xPert`Disclaimer", "[", "]"}], ":=", 
  RowBox[{
  "Print", "[", 
   "\"\<These are points 11 and 12 of the General Public \
License:\\n\\nBECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO \
WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW. EXCEPT \
WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES \
PROVIDE THE PROGRAM `AS IS\.b4 WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED \
OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF \
MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE ENTIRE RISK AS TO \
THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU. SHOULD THE PROGRAM \
PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR OR \
CORRECTION.\\n\\nIN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO \
IN WRITING WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY \
AND/OR REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR \
DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES \
ARISING OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT \
LIMITED TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED \
BY YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER \
PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE \
POSSIBILITY OF SUCH DAMAGES.\>\"", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{"On", "[", 
  RowBox[{"General", "::", "shdw"}], "]"}]}], "Input",
 InitializationCell->True],

Cell["If this is the last package show the GPL short disclaimer:", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"xAct`xCore`Private`$LastPackage", "===", "\"\<xAct`xPert`\>\""}],
     ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Unset", "[", "xAct`xCore`Private`$LastPackage", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "xAct`xCore`Private`bars", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
     "Print", "[", 
      "\"\<These packages come with ABSOLUTELY NO WARRANTY; for details type \
Disclaimer[]. This is free software, and you are welcome to redistribute it \
under certain conditions. See the General Public License for details.\>\"", 
      "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "xAct`xCore`Private`bars", "]"}]}]}], "]"}], 
  ";"}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"],

Cell[BoxData["\<\"These packages come with ABSOLUTELY NO WARRANTY; for \
details type Disclaimer[]. This is free software, and you are welcome to \
redistribute it under certain conditions. See the General Public License for \
details.\"\>"], "Print"],

Cell[BoxData["\<\"------------------------------------------------------------\
\"\>"], "Print"]
}, Open  ]]
}, Open  ]],

Cell["\<\
Note that symbols in the Global` context cannot be accessed while building \
the package:\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData["$ContextPath"], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"\<\"xAct`xPert`\"\>", ",", "\<\"xAct`xTensor`\"\>", 
   ",", "\<\"xAct`xPerm`\"\>", ",", "\<\"xAct`xCore`\"\>", 
   ",", "\<\"xAct`ExpressionManipulation`\"\>", ",", "\<\"System`\"\>"}], 
  "}"}]], "Output"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData["$Context"], "Input"],

Cell[BoxData["\<\"xAct`xPert`\"\>"], "Output"]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["1.4. Set up", "Subsubsection"],

Cell["Screen all dollar indicess:", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"ReportSet", "[", 
   RowBox[{"$PrePrint", ",", "ScreenDollarIndices"}], "]"}], ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Variable \"\>", "\[InvisibleSpace]", "$PrePrint", 
   "\[InvisibleSpace]", "\<\" assigned value \"\>", "\[InvisibleSpace]", 
   "ScreenDollarIndices"}],
  SequenceForm[
  "** Variable ", $PrePrint, " assigned value ", 
   xAct`xTensor`ScreenDollarIndices],
  Editable->False]], "Print"]
}, Open  ]],

Cell["Postfix format for derivatives:", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"ReportSet", "[", 
   RowBox[{"$CovDFormat", ",", "\"\<Postfix\>\""}], "]"}], ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Variable \"\>", "\[InvisibleSpace]", "$CovDFormat", 
   "\[InvisibleSpace]", "\<\" changed from \"\>", 
   "\[InvisibleSpace]", "\<\"Prefix\"\>", "\[InvisibleSpace]", "\<\" to \"\>",
    "\[InvisibleSpace]", "\<\"Postfix\"\>"}],
  SequenceForm[
  "** Variable ", xAct`xTensor`$CovDFormat, " changed from ", "Prefix", 
   " to ", "Postfix"],
  Editable->False]], "Print"]
}, Open  ]],

Cell[TextData[{
 "In ",
 StyleBox["xPert",
  FontSlant->"Italic"],
 " we shall allow metric contractions everywhere:"
}], "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"ReportSetOption", "[", 
   RowBox[{"ContractMetric", ",", 
    RowBox[{"AllowUpperDerivatives", "\[Rule]", "True"}]}], "]"}], 
  ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Option \"\>", "\[InvisibleSpace]", "AllowUpperDerivatives", 
   "\[InvisibleSpace]", "\<\" of \"\>", "\[InvisibleSpace]", "ContractMetric",
    "\[InvisibleSpace]", "\<\" changed from \"\>", "\[InvisibleSpace]", 
   "False", "\[InvisibleSpace]", "\<\" to \"\>", "\[InvisibleSpace]", "True"}],
  SequenceForm[
  "** Option ", xAct`xTensor`AllowUpperDerivatives, " of ", 
   xAct`xTensor`ContractMetric, " changed from ", False, " to ", True],
  Editable->False]], "Print"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"ReportSetOption", "[", 
   RowBox[{"MakeRule", ",", 
    RowBox[{"MetricOn", "\[Rule]", "All"}]}], "]"}], ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Option \"\>", "\[InvisibleSpace]", "MetricOn", 
   "\[InvisibleSpace]", "\<\" of \"\>", "\[InvisibleSpace]", "MakeRule", 
   "\[InvisibleSpace]", "\<\" changed from \"\>", "\[InvisibleSpace]", "None",
    "\[InvisibleSpace]", "\<\" to \"\>", "\[InvisibleSpace]", "All"}],
  SequenceForm[
  "** Option ", xAct`xTensor`MetricOn, " of ", xAct`xTensor`MakeRule, 
   " changed from ", None, " to ", All],
  Editable->False]], "Print"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"ReportSetOption", "[", 
   RowBox[{"MakeRule", ",", 
    RowBox[{"ContractMetrics", "\[Rule]", "True"}]}], "]"}], ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"** Option \"\>", "\[InvisibleSpace]", "ContractMetrics", 
   "\[InvisibleSpace]", "\<\" of \"\>", "\[InvisibleSpace]", "MakeRule", 
   "\[InvisibleSpace]", "\<\" changed from \"\>", "\[InvisibleSpace]", 
   "False", "\[InvisibleSpace]", "\<\" to \"\>", "\[InvisibleSpace]", "True"}],
  SequenceForm[
  "** Option ", xAct`xTensor`ContractMetrics, " of ", xAct`xTensor`MakeRule, 
   " changed from ", False, " to ", True],
  Editable->False]], "Print"]
}, Open  ]],

Cell["We do not modify the the option MathLink of CanonicalPerm:", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Options", "[", "CanonicalPerm", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"MathLink", "\[RuleDelayed]", "$xpermQ"}], ",", 
   RowBox[{"TimeVerbose", "\[Rule]", "False"}], ",", 
   RowBox[{"xPermVerbose", "\[Rule]", "False"}], ",", 
   RowBox[{"OrderedBase", "\[Rule]", "True"}]}], "}"}]], "Output"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData["$xpermQ"], "Input"],

Cell[BoxData["True"], "Output"]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["1.5. Usage messages", "Subsubsection"],

Cell["Define perturbation objects:", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Perturbation", "::", "usage"}], "=", 
   "\"\<Perturbation[expr] represents the perturbation of expr. \
Perturbation[expr, n] represents its n-th perturbation. Perturbation is an \
inert-head.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Perturbed", "::", "usage"}], "=", 
   "\"\<Perturbed[expr, n] returns the expansion of expr perturbed up to n-th \
order, using $PerturbationParameter.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"$PerturbationParameter", "::", "usage"}], "=", 
   "\"\<$PerturbationParameter is a global variable containing the parameter \
used in the perturbative expansions.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PerturbationParameter", "::", "usage"}], "=", 
   "\"\<PerturbationParameter[metric] stores the perturbation parameter \
associated to the perturbation of the given metric.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExpandPerturbation", "::", "usage"}], "=", 
   "\"\<ExpandPerturbation[expr] returns expr with all Perturbation \
expressions expanded in terms of metric perturbations. It uses fast \
pre-stored formulas for the general term of the perturbative expansion of the \
most common curvature tensors.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DefTensorPerturbation", "::", "usage"}], "=", 
   "\"\<DefTensorPerturbation[pert[LI[n], inds], tensor[inds], args] defines \
pert to be the perturbation of tensor, with the same index configuration. \
There is an internal call to DefTensor[pert[LI[n], inds], args].\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PerturbationOrder", "::", "usage"}], "=", 
   "\"\<PerturbationOrder[expr] gives the perturbative order of expression, \
as given by the orders of its arguments. This function must be defined on \
those perturbations declared by the user.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GaugeChange", "::", "usage"}], "=", 
   "\"\<GaugeChange[pert, gen] returns the perturbative expression pert \
changed to a new gauge. The change of gauge is parametrized by the family of \
vector fields gen[LI[order], a]. Background objects are left \
untouched.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GeneralPerturbation", "::", "usage"}], "=", 
   "\"\<GeneralPerturbation[expr, n] returns \
ExpandPerturbation[Perturbation[expr, n]]. This is kept for backwards \
compatibility with older versions.\>\""}], ";"}]}], "Input",
 InitializationCell->True],

Cell["\<\
Perturbation structure on already existing vbundle and metric:\
\>", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefMetricPerturbation", "::", "usage"}], "=", 
   "\"\<DefMetricPerturbation[metric, pert, param] constructs a number of \
definitions for the perturbation of the given metric, which must exist \
already. A tensor pert[LI[order], -a, -b] is defined on the vbundle of the \
metric, and the parameter param will be defined and used to expand the \
perturbed expressions. DefMetricPerturbation[metric, pert] uses a default \
name for the parameter.\>\""}], ";"}]], "Input",
 InitializationCell->True],

Cell["Versions:", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"xAct`xPert`$Version", "::", "usage"}], "=", 
   "\"\<$Version is a global variable giving the version of the package xPert \
in use.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"xAct`xPert`$xTensorVersionExpected", "::", "usage"}], "=", 
   "\"\<$xTensorVersionExpected is a global variable giving the oldest \
possible version of the package xTensor which is required by the version of \
the package xPert in use.\>\""}], ";"}]}], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["1.6. Begin private", "Subsubsection"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Begin", "[", "\"\<xAct`xPert`Private`\>\"", "]"}]], "Input",
 InitializationCell->True],

Cell[BoxData["\<\"xAct`xPert`Private`\"\>"], "Output"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Names", "[", "\"\<xAct`xPert`*\>\"", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"\<\"DefMetricPerturbation\"\>", 
   ",", "\<\"DefTensorPerturbation\"\>", ",", "\<\"Disclaimer\"\>", 
   ",", "\<\"ExpandPerturbation\"\>", ",", "\<\"GaugeChange\"\>", 
   ",", "\<\"GeneralPerturbation\"\>", ",", "\<\"Perturbation\"\>", 
   ",", "\<\"PerturbationOrder\"\>", ",", "\<\"PerturbationParameter\"\>", 
   ",", "\<\"Perturbed\"\>", ",", "\<\"$PerturbationParameter\"\>", 
   ",", "\<\"$Version\"\>", ",", "\<\"$xTensorVersionExpected\"\>"}], 
  "}"}]], "Output"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"%", "//", "Length"}]], "Input"],

Cell[BoxData["13"], "Output"]
}, Open  ]],

Cell["\<\
There are 12 symbols in this package, but only 4 are nontrivial.\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData["$ContextPath"], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"\<\"xAct`xPert`\"\>", ",", "\<\"xAct`xTensor`\"\>", 
   ",", "\<\"xAct`xPerm`\"\>", ",", "\<\"xAct`xCore`\"\>", 
   ",", "\<\"xAct`ExpressionManipulation`\"\>", ",", "\<\"System`\"\>"}], 
  "}"}]], "Output"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData["$Context"], "Input"],

Cell[BoxData["\<\"xAct`xPert`Private`\"\>"], "Output"]
}, Open  ]]
}, Closed]]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["2. Partitions",
 FontColor->RGBColor[0, 0, 1]]], "Subsection"],

Cell[CellGroupData[{

Cell["2.1. Sorted partitions", "Subsubsection"],

Cell[TextData[{
 "Generation of sorted partitions. The function group gives all partitions of \
length n-1 from a partition of length n. The function ",
 StyleBox["SortedPartitions",
  FontFamily->"Courier"],
 " simply computes all partitions starting from (1,1,...,1) applying group[ ] \
recursively until reaching length 0."
}], "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{"group", "[", "list_List", "]"}], ":=", 
  RowBox[{"Table", "[", 
   RowBox[{
    RowBox[{"Join", "[", 
     RowBox[{
      RowBox[{"Take", "[", 
       RowBox[{"list", ",", 
        RowBox[{"i", "-", "1"}]}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"list", "[", 
         RowBox[{"[", "i", "]"}], "]"}], "+", 
        RowBox[{"list", "[", 
         RowBox[{"[", 
          RowBox[{"i", "+", "1"}], "]"}], "]"}]}], "}"}], ",", 
      RowBox[{"Drop", "[", 
       RowBox[{"list", ",", 
        RowBox[{"i", "+", "1"}]}], "]"}]}], "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"i", ",", "1", ",", 
      RowBox[{
       RowBox[{"Length", "[", "list", "]"}], "-", "1"}]}], "}"}]}], 
   "]"}]}]], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{"SortedPartitions", "[", 
   RowBox[{"n_Integer", "?", "Positive"}], "]"}], ":=", 
  RowBox[{"Flatten", "[", 
   RowBox[{
    RowBox[{"FixedPointList", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Union", "@", 
        RowBox[{"Flatten", "[", 
         RowBox[{
          RowBox[{"group", "/@", "#"}], ",", "1"}], "]"}]}], "&"}], ",", 
      RowBox[{"{", 
       RowBox[{"Table", "[", 
        RowBox[{"1", ",", 
         RowBox[{"{", "n", "}"}]}], "]"}], "}"}]}], "]"}], ",", "1"}], 
   "]"}]}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"SortedPartitions", "[", "5", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"1", ",", "1", ",", "1", ",", "1", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "1", ",", "1", ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "1", ",", "2", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "2", ",", "1", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"2", ",", "1", ",", "1", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "1", ",", "3"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "2", ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "3", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"2", ",", "1", ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"2", ",", "2", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"3", ",", "1", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "4"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"2", ",", "3"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"3", ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"4", ",", "1"}], "}"}], ",", 
   RowBox[{"{", "5", "}"}]}], "}"}]], "Output"]
}, Open  ]],

Cell["Lengths 2^(i-1):", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Table", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"i", ",", 
     RowBox[{"Length", "[", 
      RowBox[{"SortedPartitions", "[", "i", "]"}], "]"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"i", ",", "12"}], "}"}]}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"1", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"2", ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"3", ",", "4"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"4", ",", "8"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"5", ",", "16"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"6", ",", "32"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"7", ",", "64"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"8", ",", "128"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"9", ",", "256"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"10", ",", "512"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"11", ",", "1024"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"12", ",", "2048"}], "}"}]}], "}"}]], "Output"]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["2.2. All partitions. Generalized Leibniz rule", "Subsubsection"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"addone", "[", "n_", "]"}], "[", 
    RowBox[{"{", "prev___Integer", "}"}], "]"}], ":=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"prev", ",", "i"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "0", ",", 
       RowBox[{"n", "-", 
        RowBox[{"Total", "[", 
         RowBox[{"{", "prev", "}"}], "]"}]}]}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"onelevel", "[", "n_", "]"}], "[", "list_List", "]"}], ":=", 
   RowBox[{"Apply", "[", 
    RowBox[{"Join", ",", 
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{"addone", "[", "n", "]"}], ",", "list"}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"complete", "[", "n_", "]"}], "[", 
    RowBox[{"{", "prev___Integer", "}"}], "]"}], ":=", 
   RowBox[{"{", 
    RowBox[{"prev", ",", 
     RowBox[{"n", "-", 
      RowBox[{"Total", "[", 
       RowBox[{"{", "prev", "}"}], "]"}]}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"lastlevel", "[", "n_", "]"}], "[", "list_List", "]"}], ":=", 
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{"complete", "[", "n", "]"}], ",", "list"}], "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"AllPartitions", "[", 
    RowBox[{"0", ",", "n_Integer"}], "]"}], ":=", 
   RowBox[{"{", "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"AllPartitions", "[", 
    RowBox[{"m_Integer", ",", "n_Integer"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"lastlevel", "[", "n", "]"}], "[", 
    RowBox[{"Nest", "[", 
     RowBox[{
      RowBox[{"onelevel", "[", "n", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"{", "}"}], "}"}], ",", 
      RowBox[{"m", "-", "1"}]}], "]"}], "]"}]}], ";"}]}], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"AllPartitions", "[", 
  RowBox[{"4", ",", "3"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"0", ",", "0", ",", "0", ",", "3"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"0", ",", "0", ",", "1", ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"0", ",", "0", ",", "2", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"0", ",", "0", ",", "3", ",", "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"0", ",", "1", ",", "0", ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"0", ",", "1", ",", "1", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"0", ",", "1", ",", "2", ",", "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"0", ",", "2", ",", "0", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"0", ",", "2", ",", "1", ",", "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"0", ",", "3", ",", "0", ",", "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "0", ",", "0", ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "0", ",", "1", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "0", ",", "2", ",", "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "1", ",", "0", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "1", ",", "1", ",", "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"1", ",", "2", ",", "0", ",", "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"2", ",", "0", ",", "0", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"2", ",", "0", ",", "1", ",", "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"2", ",", "1", ",", "0", ",", "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"3", ",", "0", ",", "0", ",", "0"}], "}"}]}], "}"}]], "Output"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"LeibnizDistribute", "[", 
    RowBox[{"operator_", ",", "n_", ",", 
     RowBox[{"f_", "[", "args___", "]"}], ",", "g_"}], "]"}], ":=", 
   RowBox[{"Apply", "[", 
    RowBox[{"g", ",", 
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"Multinomial", "@@", "#"}], " ", 
         RowBox[{"Inner", "[", 
          RowBox[{"operator", ",", 
           RowBox[{"{", "args", "}"}], ",", "#", ",", "f"}], "]"}]}], "&"}], 
       ",", 
       RowBox[{"AllPartitions", "[", 
        RowBox[{
         RowBox[{"Length", "[", 
          RowBox[{"{", "args", "}"}], "]"}], ",", "n"}], "]"}]}], "]"}]}], 
    "]"}]}], ";"}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Expand", "[", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{"a", "+", "b", "+", "c", "+", "d", "+", "e", "+", "f"}], ")"}], 
     "^", "20"}], "]"}], "//", "Length"}], "//", "AbsoluteTiming"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"0.305556`5.936635809587517", " ", "Second"}], ",", "53130"}], 
  "}"}]], "Output"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"AllPartitions", "[", 
    RowBox[{"6", ",", "20"}], "]"}], "//", "Length"}], "//", 
  "AbsoluteTiming"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"0.570106`6.207500605195036", " ", "Second"}], ",", "53130"}], 
  "}"}]], "Output"]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["2.3. Folded partitions. Fa`a di Bruno rule", "Subsubsection"],

Cell["\<\
This are partitions {k1, ..., kn} of integer n obeying Sum[i*ki, {i,n}] \
\[Equal] n .\
\>", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FoldedPartitions", "[", "n_", "]"}], ":=", 
   RowBox[{"Cases", "[", 
    RowBox[{
     RowBox[{"Fold", "[", 
      RowBox[{"step", ",", 
       RowBox[{"fpart", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", "}"}], ",", "n"}], "}"}], ",", "n"}], "]"}], ",", 
       RowBox[{"Reverse", "@", 
        RowBox[{"Range", "[", 
         RowBox[{"n", "-", "1"}], "]"}]}]}], "]"}], ",", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"partition_", ",", "0"}], "}"}], "\[RuleDelayed]", 
      "partition"}]}], "]"}]}], ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"fpart", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "part___", "}"}], ",", "0"}], "}"}], ",", "d_"}], "]"}], ":=", 
   RowBox[{"{", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"0", ",", "part"}], "}"}], ",", "0"}], "}"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"fpart", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "part___", "}"}], ",", "m_"}], "}"}], ",", "d_"}], "]"}], 
   ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"#", ",", "part"}], "}"}], ",", 
       RowBox[{"m", "-", 
        RowBox[{"d", " ", "#"}]}]}], "}"}], "&"}], "/@", 
    RowBox[{"Range", "[", 
     RowBox[{"0", ",", 
      RowBox[{"m", "/", "d"}]}], "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"step", "[", 
    RowBox[{"pairs_List", ",", "d_"}], "]"}], ":=", 
   RowBox[{"Flatten", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"fpart", "[", 
        RowBox[{"#", ",", "d"}], "]"}], "&"}], "/@", "pairs"}], ",", "1"}], 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->True],

Cell["\<\
Folded partitions are currently being used by the GaugeChange formula.\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"FoldedPartitions", "[", "8", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
    "8", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "6", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "4", ",", "2", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "2", ",", "3", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "0", ",", "4", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "5", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "3", ",", "1", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "1", ",", "2", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "2", ",", "0", ",", "2", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "0", ",", "1", ",", "2", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "4", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "2", ",", "1", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "0", ",", "2", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "1", ",", "0", ",", "1", ",", "1", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "0", ",", "0", ",", "0", ",", "2", ",", "0", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "3", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "1", ",", "1", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "0", ",", "0", ",", "1", ",", "0", ",", "1", ",", "0", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "2", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", 
     "0"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
     "1"}], "}"}]}], "}"}]], "Output"]
}, Open  ]],

Cell["Fa`a di Bruno formula:", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"faa", "[", "expr_", "]"}], "[", 
    RowBox[{"ki_", ",", 
     RowBox[{"{", "0", "}"}]}], "]"}], ":=", 
   RowBox[{
    RowBox[{"Scalar", "[", "expr", "]"}], "^", "ki"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"faa", "[", "expr_", "]"}], "[", 
    RowBox[{"1", ",", 
     RowBox[{"{", "i_", "}"}]}], "]"}], ":=", 
   RowBox[{
    RowBox[{"Perturbation", "[", 
     RowBox[{"expr", ",", "i"}], "]"}], "/", 
    RowBox[{"i", "!"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"faa", "[", "expr_", "]"}], "[", 
    RowBox[{"ki_", ",", 
     RowBox[{"{", "i_", "}"}]}], "]"}], ":=", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{"Scalar", "@", 
       RowBox[{"Perturbation", "[", 
        RowBox[{"expr", ",", "i"}], "]"}]}], "/", 
      RowBox[{"i", "!"}]}], ")"}], "^", "ki"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FaadiBruno1", "[", 
    RowBox[{"partition_", ",", 
     RowBox[{"function_", "[", "expr_", "]"}]}], "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"n", "=", 
        RowBox[{"partition", ".", 
         RowBox[{"Range", "[", 
          RowBox[{"Length", "[", "partition", "]"}], "]"}]}]}], ",", 
       RowBox[{"k", "=", 
        RowBox[{"Plus", "@@", "partition"}]}]}], "}"}], ",", 
     RowBox[{
      RowBox[{
       RowBox[{"n", "!"}], "/", 
       RowBox[{"Apply", "[", 
        RowBox[{"Times", ",", 
         RowBox[{"Factorial", "/@", "partition"}]}], "]"}]}], 
      RowBox[{
       RowBox[{
        RowBox[{"Derivative", "[", "k", "]"}], "[", "function", "]"}], "[", 
       "expr", "]"}], 
      RowBox[{"Times", "@@", 
       RowBox[{"MapIndexed", "[", 
        RowBox[{
         RowBox[{"faa", "[", "expr", "]"}], ",", "partition"}], "]"}]}]}]}], 
    "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FaadiBruno1", "[", 
    RowBox[{"partition_", ",", 
     RowBox[{"Power", "[", 
      RowBox[{"expr_", ",", "exponent_"}], "]"}]}], "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"n", "=", 
        RowBox[{"partition", ".", 
         RowBox[{"Range", "[", 
          RowBox[{"Length", "[", "partition", "]"}], "]"}]}]}], ",", 
       RowBox[{"k", "=", 
        RowBox[{"Plus", "@@", "partition"}]}]}], "}"}], ",", 
     RowBox[{
      RowBox[{
       RowBox[{"n", "!"}], "/", 
       RowBox[{"Apply", "[", 
        RowBox[{"Times", ",", 
         RowBox[{"Factorial", "/@", "partition"}]}], "]"}]}], 
      RowBox[{
       RowBox[{
        RowBox[{"Derivative", "[", 
         RowBox[{"k", ",", "0"}], "]"}], "[", "Power", "]"}], "[", 
       RowBox[{"expr", ",", "exponent"}], "]"}], 
      RowBox[{"Times", "@@", 
       RowBox[{"MapIndexed", "[", 
        RowBox[{
         RowBox[{"faa", "[", "expr", "]"}], ",", "partition"}], "]"}]}]}]}], 
    "]"}]}], ";"}]}], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FaadiBruno0", "[", 
   RowBox[{"expr_", ",", "order_"}], "]"}], ":=", 
  RowBox[{"Apply", "[", 
   RowBox[{"Plus", ",", 
    RowBox[{
     RowBox[{
      RowBox[{"FaadiBruno1", "[", 
       RowBox[{"#", ",", "expr"}], "]"}], "&"}], "/@", 
     RowBox[{"FoldedPartitions", "[", "order", "]"}]}]}], "]"}]}]], "Input"],

Cell[TextData[{
 "A simpler and more general version based on the Dt builtin of ",
 StyleBox["Mathematica.",
  FontSlant->"Italic"],
 " Arguments of Power are wrapped with Scalar:"
}], "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FaadiBruno", "[", 
    RowBox[{
     RowBox[{"function_", "[", "args__", "]"}], ",", "order_"}], "]"}], ":=", 
   
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"vars", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"Unique", "[", "x", "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"Length", "[", 
           RowBox[{"{", "args", "}"}], "]"}], "}"}]}], "]"}]}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"Expand", "@", 
          RowBox[{"Nest", "[", 
           RowBox[{"Dt", ",", 
            RowBox[{"function", "@@", "vars"}], ",", "order"}], "]"}]}], "/.", 
         RowBox[{"Dt", "\[Rule]", "Perturbation"}]}], "/.", 
        RowBox[{
         RowBox[{"Power", "[", 
          RowBox[{"x_Perturbation", ",", "n_"}], "]"}], ":>", 
         RowBox[{
          RowBox[{"Scalar", "[", "x", "]"}], "^", "n"}]}]}], "/.", 
       RowBox[{
        RowBox[{
         RowBox[{"g_", "?", "ScalarFunctionQ"}], "@@", "vars"}], ":>", 
        RowBox[{"g", "[", "args", "]"}]}]}], "/.", 
      RowBox[{"Inner", "[", 
       RowBox[{"IndexRule", ",", "vars", ",", 
        RowBox[{"{", "args", "}"}], ",", "List"}], "]"}]}]}], "]"}]}], 
  ";"}]], "Input",
 InitializationCell->True],

Cell["Tests:", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FaadiBruno", "[", 
    RowBox[{
     RowBox[{"function", "[", "x", "]"}], ",", "7"}], "]"}], "-", 
   RowBox[{"FaadiBruno0", "[", 
    RowBox[{
     RowBox[{"function", "[", "x", "]"}], ",", "7"}], "]"}]}], "//", 
  "NoScalar"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", 
      RowBox[{"Perturbation", "[", 
       RowBox[{"Perturbation", "[", 
        RowBox[{"Perturbation", "[", 
         RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}], "]"}], "]"}], 
     "]"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", "\[Prime]",
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "7"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", "\[Prime]",
     MultilineFunction->None], "[", "x", "]"}]}], "+", 
  RowBox[{"35", " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", 
      RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", "\[Prime]\[Prime]",
     MultilineFunction->None], "[", "x", "]"}]}], "+", 
  RowBox[{"21", " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "x", "]"}], "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", 
      RowBox[{"Perturbation", "[", 
       RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}], "]"}], "]"}], 
   " ", 
   RowBox[{
    SuperscriptBox["function", "\[Prime]\[Prime]",
     MultilineFunction->None], "[", "x", "]"}]}], "+", 
  RowBox[{"7", " ", 
   RowBox[{"Perturbation", "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", 
      RowBox[{"Perturbation", "[", 
       RowBox[{"Perturbation", "[", 
        RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}], "]"}], "]"}], 
    "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", "\[Prime]\[Prime]",
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{"35", " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "3"}], "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "4"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", "\[Prime]\[Prime]",
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{"21", " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "2"}], "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "5"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", "\[Prime]\[Prime]",
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{"7", " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "1"}], "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "6"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", "\[Prime]\[Prime]",
     MultilineFunction->None], "[", "x", "]"}]}], "+", 
  RowBox[{"105", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "3", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "+", 
  RowBox[{"70", " ", 
   RowBox[{"Perturbation", "[", "x", "]"}], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", 
      RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}], "2"], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "3", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "+", 
  RowBox[{"105", " ", 
   RowBox[{"Perturbation", "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "x", "]"}], "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", 
      RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "3", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "+", 
  RowBox[{"21", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", 
      RowBox[{"Perturbation", "[", 
       RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}], "]"}], "]"}], 
   " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "3", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{"105", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"x", ",", "2"}], "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "3"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "3", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{"70", " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "1"}], "]"}], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"x", ",", "3"}], "]"}], "2"], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "3", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{"105", " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "1"}], "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "2"}], "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "4"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "3", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{"21", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"x", ",", "1"}], "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "5"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "3", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "+", 
  RowBox[{"105", " ", 
   RowBox[{"Perturbation", "[", "x", "]"}], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "3"], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "4", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "+", 
  RowBox[{"210", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "x", "]"}], "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "4", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "+", 
  RowBox[{"35", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "3"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", 
      RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "4", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{"105", " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "1"}], "]"}], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"x", ",", "2"}], "]"}], "3"], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "4", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{"210", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"x", ",", "1"}], "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "2"}], "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "3"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "4", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{"35", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"x", ",", "1"}], "]"}], "3"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "4"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "4", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "+", 
  RowBox[{"105", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "3"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "2"], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "5", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "+", 
  RowBox[{"35", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "4"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "5", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{"105", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"x", ",", "1"}], "]"}], "3"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"x", ",", "2"}], "]"}], "2"], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "5", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{"35", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"x", ",", "1"}], "]"}], "4"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "3"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "5", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "+", 
  RowBox[{"21", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "5"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "x", "]"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "6", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{"21", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"x", ",", "1"}], "]"}], "5"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "2"}], "]"}], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "6", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "+", 
  RowBox[{
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "7"], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "7", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}], "-", 
  RowBox[{
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"x", ",", "1"}], "]"}], "7"], " ", 
   RowBox[{
    SuperscriptBox["function", 
     TagBox[
      RowBox[{"(", "7", ")"}],
      Derivative],
     MultilineFunction->None], "[", "x", "]"}]}]}]], "Output"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FaadiBruno", "[", 
     RowBox[{
      RowBox[{"x", "^", "5"}], ",", "4"}], "]"}], "-", 
    RowBox[{"FaadiBruno0", "[", 
     RowBox[{
      RowBox[{"x", "^", "5"}], ",", "4"}], "]"}]}], "//", "NoScalar"}], "//", 
  "Expand"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   SuperscriptBox["x", "5"], " ", 
   SuperscriptBox[
    RowBox[{
     InterpretationBox[
      StyleBox["Log",
       AutoSpacing->False],
      Log,
      Editable->False], "[", "x", "]"}], "4"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "5", "]"}], "4"]}], "+", 
  RowBox[{"12", " ", 
   SuperscriptBox["x", "4"], " ", 
   SuperscriptBox[
    RowBox[{
     InterpretationBox[
      StyleBox["Log",
       AutoSpacing->False],
      Log,
      Editable->False], "[", "x", "]"}], "2"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "5", "]"}], "3"], " ", 
   RowBox[{"Perturbation", "[", "x", "]"}]}], "+", 
  RowBox[{"20", " ", 
   SuperscriptBox["x", "4"], " ", 
   SuperscriptBox[
    RowBox[{
     InterpretationBox[
      StyleBox["Log",
       AutoSpacing->False],
      Log,
      Editable->False], "[", "x", "]"}], "3"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "5", "]"}], "3"], " ", 
   RowBox[{"Perturbation", "[", "x", "]"}]}], "+", 
  RowBox[{"12", " ", 
   SuperscriptBox["x", "3"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "5", "]"}], "2"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "2"]}], "+", 
  RowBox[{"108", " ", 
   SuperscriptBox["x", "3"], " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Log",
      AutoSpacing->False],
     Log,
     Editable->False], "[", "x", "]"}], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "5", "]"}], "2"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "2"]}], "+", 
  RowBox[{"120", " ", 
   SuperscriptBox["x", "3"], " ", 
   SuperscriptBox[
    RowBox[{
     InterpretationBox[
      StyleBox["Log",
       AutoSpacing->False],
      Log,
      Editable->False], "[", "x", "]"}], "2"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "5", "]"}], "2"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "2"]}], "+", 
  RowBox[{"188", " ", 
   SuperscriptBox["x", "2"], " ", 
   RowBox[{"Perturbation", "[", "5", "]"}], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "3"]}], "+", 
  RowBox[{"240", " ", 
   SuperscriptBox["x", "2"], " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Log",
      AutoSpacing->False],
     Log,
     Editable->False], "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", "5", "]"}], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "3"]}], "+", 
  RowBox[{"120", " ", "x", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "4"]}], "+", 
  RowBox[{"6", " ", 
   SuperscriptBox["x", "5"], " ", 
   SuperscriptBox[
    RowBox[{
     InterpretationBox[
      StyleBox["Log",
       AutoSpacing->False],
      Log,
      Editable->False], "[", "x", "]"}], "3"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "5", "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "5", "]"}], "]"}]}], "+", 
  RowBox[{"24", " ", 
   SuperscriptBox["x", "4"], " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Log",
      AutoSpacing->False],
     Log,
     Editable->False], "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", "5", "]"}], " ", 
   RowBox[{"Perturbation", "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "5", "]"}], "]"}]}], "+", 
  RowBox[{"60", " ", 
   SuperscriptBox["x", "4"], " ", 
   SuperscriptBox[
    RowBox[{
     InterpretationBox[
      StyleBox["Log",
       AutoSpacing->False],
      Log,
      Editable->False], "[", "x", "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", "5", "]"}], " ", 
   RowBox[{"Perturbation", "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "5", "]"}], "]"}]}], "+", 
  RowBox[{"54", " ", 
   SuperscriptBox["x", "3"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "5", "]"}], "]"}]}], "+", 
  RowBox[{"120", " ", 
   SuperscriptBox["x", "3"], " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Log",
      AutoSpacing->False],
     Log,
     Editable->False], "[", "x", "]"}], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "5", "]"}], "]"}]}], "+", 
  RowBox[{"3", " ", 
   SuperscriptBox["x", "5"], " ", 
   SuperscriptBox[
    RowBox[{
     InterpretationBox[
      StyleBox["Log",
       AutoSpacing->False],
      Log,
      Editable->False], "[", "x", "]"}], "2"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "5", "]"}], "]"}], "2"]}], "+", 
  RowBox[{"12", " ", 
   SuperscriptBox["x", "4"], " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Log",
      AutoSpacing->False],
     Log,
     Editable->False], "[", "x", "]"}], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "5", "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "x", "]"}], "]"}]}], "+", 
  RowBox[{"30", " ", 
   SuperscriptBox["x", "4"], " ", 
   SuperscriptBox[
    RowBox[{
     InterpretationBox[
      StyleBox["Log",
       AutoSpacing->False],
      Log,
      Editable->False], "[", "x", "]"}], "2"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "5", "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "x", "]"}], "]"}]}], "+", 
  RowBox[{"108", " ", 
   SuperscriptBox["x", "3"], " ", 
   RowBox[{"Perturbation", "[", "5", "]"}], " ", 
   RowBox[{"Perturbation", "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "x", "]"}], "]"}]}], "+", 
  RowBox[{"240", " ", 
   SuperscriptBox["x", "3"], " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Log",
      AutoSpacing->False],
     Log,
     Editable->False], "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", "5", "]"}], " ", 
   RowBox[{"Perturbation", "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "x", "]"}], "]"}]}], "+", 
  RowBox[{"360", " ", 
   SuperscriptBox["x", "2"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", "x", "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "x", "]"}], "]"}]}], "+", 
  RowBox[{"6", " ", 
   SuperscriptBox["x", "4"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "5", "]"}], "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "x", "]"}], "]"}]}], "+", 
  RowBox[{"30", " ", 
   SuperscriptBox["x", "4"], " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Log",
      AutoSpacing->False],
     Log,
     Editable->False], "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "5", "]"}], "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", "x", "]"}], "]"}]}], "+", 
  RowBox[{"60", " ", 
   SuperscriptBox["x", "3"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "2"]}], "+", 
  RowBox[{"4", " ", 
   SuperscriptBox["x", "5"], " ", 
   SuperscriptBox[
    RowBox[{
     InterpretationBox[
      StyleBox["Log",
       AutoSpacing->False],
      Log,
      Editable->False], "[", "x", "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", "5", "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "5", "]"}], "]"}], "]"}]}], "+", 
  RowBox[{"4", " ", 
   SuperscriptBox["x", "4"], " ", 
   RowBox[{"Perturbation", "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "5", "]"}], "]"}], "]"}]}], "+", 
  RowBox[{"20", " ", 
   SuperscriptBox["x", "4"], " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Log",
      AutoSpacing->False],
     Log,
     Editable->False], "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "5", "]"}], "]"}], "]"}]}], "+", 
  RowBox[{"4", " ", 
   SuperscriptBox["x", "4"], " ", 
   RowBox[{"Perturbation", "[", "5", "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}]}], "+", 
  RowBox[{"20", " ", 
   SuperscriptBox["x", "4"], " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Log",
      AutoSpacing->False],
     Log,
     Editable->False], "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", "5", "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}]}], "+", 
  RowBox[{"80", " ", 
   SuperscriptBox["x", "3"], " ", 
   RowBox[{"Perturbation", "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}]}], "+", 
  RowBox[{
   SuperscriptBox["x", "5"], " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Log",
      AutoSpacing->False],
     Log,
     Editable->False], "[", "x", "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", 
      RowBox[{"Perturbation", "[", "5", "]"}], "]"}], "]"}], "]"}]}], "+", 
  RowBox[{"5", " ", 
   SuperscriptBox["x", "4"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"Perturbation", "[", 
      RowBox[{"Perturbation", "[", "x", "]"}], "]"}], "]"}], "]"}]}], "-", 
  RowBox[{"120", " ", "x", " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"x", ",", "1"}], "]"}], "4"]}], "-", 
  RowBox[{"360", " ", 
   SuperscriptBox["x", "2"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"x", ",", "1"}], "]"}], "2"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "2"}], "]"}]}], "-", 
  RowBox[{"60", " ", 
   SuperscriptBox["x", "3"], " ", 
   SuperscriptBox[
    RowBox[{"Perturbation", "[", 
     RowBox[{"x", ",", "2"}], "]"}], "2"]}], "-", 
  RowBox[{"80", " ", 
   SuperscriptBox["x", "3"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "1"}], "]"}], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "3"}], "]"}]}], "-", 
  RowBox[{"5", " ", 
   SuperscriptBox["x", "4"], " ", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"x", ",", "4"}], "]"}]}]}]], "Output"]
}, Open  ]]
}, Closed]]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["3. Perturbation structure",
 FontColor->RGBColor[0, 0, 1]]], "Subsection"],

Cell[BoxData[
 RowBox[{"Off", "[", 
  RowBox[{"RuleDelayed", "::", "rhs"}], "]"}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell["3.1. DefTensorPerturbation", "Subsubsection"],

Cell["\<\
Given a tensor, we define its perturbation, with the same index structure and \
tensor properties:\
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"makepattern", "[", "a_Symbol", "]"}], ":=", "a_Symbol"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"makepattern", "[", 
    RowBox[{"-", "a_Symbol"}], "]"}], ":=", 
   RowBox[{"-", "a_Symbol"}]}], ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "DefTensorPerturbation", "]"}], "=", 
   RowBox[{"Options", "[", "DefTensor", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DefTensorPerturbation", "[", 
    RowBox[{
     RowBox[{"pert_", "[", 
      RowBox[{
       RowBox[{"LI", "[", "_", "]"}], ",", "inds___"}], "]"}], ",", 
     RowBox[{"tensor_", "[", "inds___", "]"}], ",", "args__"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"prot", ",", 
       RowBox[{"pinds", "=", 
        RowBox[{"makepattern", "/@", 
         RowBox[{"{", "inds", "}"}]}]}]}], "}"}], ",", "\[IndentingNewLine]", 
     
     RowBox[{
      RowBox[{"DefTensor", "[", 
       RowBox[{
        RowBox[{"pert", "[", 
         RowBox[{
          RowBox[{"LI", "[", "\"\<order\>\"", "]"}], ",", "inds"}], "]"}], 
        ",", "args"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"xAct`xTensor`Private`SymbolRelations", "[", 
       RowBox[{"pert", ",", "Null", ",", 
        RowBox[{"{", "tensor", "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"prot", "=", 
       RowBox[{"Unprotect", "[", 
        RowBox[{"tensor", ",", "pert"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"tensor", "/:", 
       RowBox[{"Perturbation", "[", 
        RowBox[{
         RowBox[{"tensor", "@@", "pinds"}], ",", 
         RowBox[{"Optional", "[", "order_Integer", "]"}]}], "]"}], ":=", 
       RowBox[{"pert", "[", 
        RowBox[{
         RowBox[{"LI", "[", "order", "]"}], ",", "inds"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"pert", "[", 
        RowBox[{
         RowBox[{"LI", "[", "0", "]"}], ",", "indices___"}], "]"}], ":=", 
       RowBox[{"tensor", "[", "indices", "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"pert", "/:", 
       RowBox[{"PerturbationOrder", "[", 
        RowBox[{"pert", "[", 
         RowBox[{
          RowBox[{"LI", "[", "order_", "]"}], ",", "indices___"}], "]"}], 
        "]"}], ":=", "order"}], ";", "\[IndentingNewLine]", 
      RowBox[{"pert", "/:", 
       RowBox[{"Perturbation", "[", 
        RowBox[{
         RowBox[{"pert", "[", 
          RowBox[{
           RowBox[{"LI", "[", "order_", "]"}], ",", 
           RowBox[{"Sequence", "@@", "pinds"}]}], "]"}], ",", "n_."}], "]"}], 
       ":=", 
       RowBox[{"pert", "[", 
        RowBox[{
         RowBox[{"LI", "[", 
          RowBox[{"order", "+", "n"}], "]"}], ",", "inds"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Protect", "[", 
       RowBox[{"Evaluate", "[", "prot", "]"}], "]"}], ";"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"DefTensorPerturbation", ",", 
    RowBox[{"{", 
     RowBox[{"2", ",", "Infinity"}], "}"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "DefTensorPerturbation", "]"}], ";"}]}], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["3.2. DefMetricPerturbation", "Subsubsection"],

Cell["\<\
Jose: It is rather absurd that DefTensorPerturbation requires indices but \
DefMetricPerturbation does not.\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"?", "DefMetricPerturbation"}]], "Input"],

Cell[BoxData["\<\"DefMetricPerturbation[metric, pert, param] constructs a \
number of definitions for the perturbation of the existing metric. A tensor \
pert[LI[order], -a, -b] is defined on the vbundle of the metric, and the \
parameter param will be defined and used to expand the perturbed expressions.\
\"\>"], "Print",
 CellTags->"Info3422985523-5158137"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "DefMetricPerturbation", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"PrintAs", "\[Rule]", "Identity"}], "}"}]}], ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"DefMetricPerturbation", "[", 
    RowBox[{"metric_", ",", "pert_Symbol", ",", 
     RowBox[{"param_Symbol:", "Automatic"}], ",", 
     RowBox[{"options___", "?", "OptionQ"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "vbundle", ",", "manifold", ",", "indices", ",", "covd", ",", 
       "christoffel", ",", "riemann", ",", "ricci", ",", "ricciscalar", ",", 
       "einstein", ",", "weyl", ",", "pa"}], "}"}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", "pa", "}"}], "=", 
       RowBox[{
        RowBox[{
         RowBox[{"{", "PrintAs", "}"}], "/.", 
         RowBox[{"CheckOptions", "[", "options", "]"}]}], "/.", 
        RowBox[{"Options", "[", "DefMetricPerturbation", "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Check", " ", "of", " ", "metric"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{"MetricQ", "[", "metric", "]"}]}], ",", 
        RowBox[{"Throw", "@", 
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"DefMetricPerturbation", "::", "unknown"}], ",", 
           "\"\<metric\>\"", ",", "metric"}], "]"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Define", " ", "parameter", " ", "if", " ", "it", " ", "does", " ", 
        "not", " ", "exist", " ", "yet"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{"ParameterQ", "[", "param", "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"param", "===", "Automatic"}], ",", "\[IndentingNewLine]", 
          RowBox[{"DefParameter", "[", 
           RowBox[{
            RowBox[{"GiveSymbol", "[", 
             RowBox[{"PerturbationParameter", ",", "metric"}], "]"}], ",", 
            RowBox[{"PrintAs", "\[RuleDelayed]", 
             RowBox[{"GiveOutputString", "[", 
              RowBox[{"PerturbationParameter", ",", "metric"}], "]"}]}]}], 
           "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{"DefParameter", "[", "param", "]"}]}], 
         "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"vbundle", "=", 
       RowBox[{"VBundleOfMetric", "[", "metric", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"manifold", "=", 
       RowBox[{"BaseOfVBundle", "[", "vbundle", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"indices", "=", 
       RowBox[{"GetIndicesOfVBundle", "[", 
        RowBox[{"vbundle", ",", "4"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"DefTensorPerturbation", "[", 
       RowBox[{
        RowBox[{"pert", "[", 
         RowBox[{
          RowBox[{"LI", "[", "\"\<order\>\"", "]"}], ",", 
          RowBox[{"-", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], ",", 
          RowBox[{"-", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "2", "]"}], "]"}]}]}], "]"}], ",", 
        RowBox[{"metric", "[", 
         RowBox[{
          RowBox[{"-", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], ",", 
          RowBox[{"-", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "2", "]"}], "]"}]}]}], "]"}], ",", 
        RowBox[{"DependenciesOfTensor", "[", "metric", "]"}], ",", 
        RowBox[{"Symmetric", "[", 
         RowBox[{"{", 
          RowBox[{"2", ",", "3"}], "}"}], "]"}], ",", 
        RowBox[{"PrintAs", "\[Rule]", "pa"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Store", " ", "perturbation", " ", "structure", " ", "in", " ", 
        "global", " ", "variables"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"covd", "=", 
       RowBox[{"CovDOfMetric", "[", "metric", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"christoffel", "=", 
       RowBox[{"Christoffel", "[", "covd", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"riemann", "=", 
       RowBox[{"Riemann", "[", "covd", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"ricci", "=", 
       RowBox[{"Ricci", "[", "covd", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"ricciscalar", "=", 
       RowBox[{"RicciScalar", "[", "covd", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"einstein", "=", 
       RowBox[{"Einstein", "[", "covd", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"weyl", "=", 
       RowBox[{"Weyl", "[", "covd", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"$PerturbationParameter", "=", "param"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Define", " ", "perturbation", " ", "definitions"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"Unprotect", "[", 
       RowBox[{"Perturbation", ",", "GeneralPerturbation"}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"MakexTensions", "[", 
       RowBox[{
       "DefMetricPerturbation", ",", "\"\<Beginning\>\"", ",", "metric", ",", 
        "pert", ",", "param"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"a", "=", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], ",", 
          RowBox[{"b", "=", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "2", "]"}], "]"}]}], ",", 
          RowBox[{"c", "=", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "3", "]"}], "]"}]}], ",", 
          RowBox[{"d", "=", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "4", "]"}], "]"}]}]}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"DefGenPertInvMetric", "[", 
          RowBox[{"vbundle", ",", 
           RowBox[{"metric", "[", 
            RowBox[{"a", ",", "b"}], "]"}], ",", "pert"}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"DefGenPertDet", "[", 
          RowBox[{"vbundle", ",", "metric", ",", "pert"}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"DefGenPertInvMetric", "[", 
          RowBox[{"vbundle", ",", 
           RowBox[{"metric", "[", 
            RowBox[{"a", ",", "b"}], "]"}], ",", "pert"}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"DefGenPertChristoffel", "[", 
          RowBox[{"vbundle", ",", "covd", ",", "pert", ",", 
           RowBox[{"christoffel", "[", 
            RowBox[{"a", ",", 
             RowBox[{"-", "b"}], ",", 
             RowBox[{"-", "c"}]}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"DefGenPertRiemannFromChristoffel", "[", 
          RowBox[{"vbundle", ",", "covd", ",", "christoffel", ",", 
           RowBox[{"riemann", "[", 
            RowBox[{
             RowBox[{"-", "a"}], ",", 
             RowBox[{"-", "b"}], ",", 
             RowBox[{"-", "c"}], ",", "d"}], "]"}]}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"DefGenPertRiemann", "[", 
          RowBox[{"vbundle", ",", "covd", ",", "pert", ",", 
           RowBox[{"riemann", "[", 
            RowBox[{
             RowBox[{"-", "a"}], ",", 
             RowBox[{"-", "b"}], ",", 
             RowBox[{"-", "c"}], ",", "d"}], "]"}]}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"DefGenPertRicci", "[", 
          RowBox[{"vbundle", ",", "covd", ",", "pert", ",", "riemann", ",", 
           RowBox[{"ricci", "[", 
            RowBox[{
             RowBox[{"-", "a"}], ",", 
             RowBox[{"-", "b"}]}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"DefGenPertRicciScalar", "[", 
          RowBox[{
          "vbundle", ",", "metric", ",", "ricci", ",", "ricciscalar"}], "]"}],
          ";", "\[IndentingNewLine]", 
         RowBox[{"DefGenPertEinstein", "[", 
          RowBox[{
          "vbundle", ",", "metric", ",", "ricci", ",", "ricciscalar", ",", 
           RowBox[{"einstein", "[", 
            RowBox[{
             RowBox[{"-", "a"}], ",", 
             RowBox[{"-", "b"}]}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"DefGenPertWeyl", "[", 
          RowBox[{"weyl", "[", 
           RowBox[{
            RowBox[{"-", "a"}], ",", 
            RowBox[{"-", "b"}], ",", 
            RowBox[{"-", "c"}], ",", 
            RowBox[{"-", "d"}]}], "]"}], "]"}], ";"}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"MakexTensions", "[", 
       RowBox[{
       "DefMetricPerturbation", ",", "\"\<End\>\"", ",", "metric", ",", 
        "pert", ",", "param"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Protect", "[", 
       RowBox[{"Perturbation", ",", "GeneralPerturbation"}], "]"}], ";"}]}], 
    "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"DefMetricPerturbation", ",", 
    RowBox[{"{", 
     RowBox[{"2", ",", "3"}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "DefMetricPerturbation", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell["Store the perturbation parameters of the various metrics:", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"PerturbationParameter", "[", 
    RowBox[{"metric_", "?", "MetricQ"}], "]"}], ":=", 
   RowBox[{"GiveSymbol", "[", 
    RowBox[{"PerturbationParameter", ",", "metric"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"PerturbationParameter", ",", "1"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Protect", "[", "PerturbationParameter", "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PrintAsCharacter", "[", "PerturbationParameter", "]"}], "=", 
   "\"\<\[CurlyEpsilon]\>\""}], ";"}]}], "Input",
 InitializationCell->True],

Cell["Metric perturbations:", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Unprotect", "[", "IndexForm", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"IndexForm", "[", 
    RowBox[{"LI", "[", "x_", "]"}], "]"}], ":=", 
   RowBox[{"ColorString", "[", 
    RowBox[{
     RowBox[{"ToString", "[", "x", "]"}], ",", 
     RowBox[{"RGBColor", "[", 
      RowBox[{"0", ",", "0", ",", "1"}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "IndexForm", "]"}], ";"}]}], "Input"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"IndexForm", "[", 
  RowBox[{"LI", "[", "1", "]"}], "]"}]], "Input"],

Cell[BoxData["\<\"\\!\\(\\*StyleBox[1,FontColor->RGBColor[0, 0, 1]]\\)\"\>"], \
"Output"]
}, Open  ]],

Cell["Additional object:", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"ThreePert", "[", 
    RowBox[{"covd_", ",", "pert_"}], "]"}], "[", 
   RowBox[{
    RowBox[{"LI", "[", "order_", "]"}], ",", "a_", ",", "b_", ",", "c_"}], 
   "]"}], ":=", 
  RowBox[{
   RowBox[{"1", "/", "2"}], 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{"covd", "[", "c", "]"}], "[", 
      RowBox[{"pert", "[", 
       RowBox[{
        RowBox[{"LI", "[", "order", "]"}], ",", "a", ",", "b"}], "]"}], "]"}],
      "+", 
     RowBox[{
      RowBox[{"covd", "[", "b", "]"}], "[", 
      RowBox[{"pert", "[", 
       RowBox[{
        RowBox[{"LI", "[", "order", "]"}], ",", "a", ",", "c"}], "]"}], "]"}],
      "-", 
     RowBox[{
      RowBox[{"covd", "[", "a", "]"}], "[", 
      RowBox[{"pert", "[", 
       RowBox[{
        RowBox[{"LI", "[", "order", "]"}], ",", "b", ",", "c"}], "]"}], 
      "]"}]}], ")"}]}]}]], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["3.3. Perturbation", "Subsubsection"],

Cell[TextData[{
 "Main perturbation function, defined as inert-head. That means that the \
tensorial properties of ",
 StyleBox["Perturbation[",
  FontFamily->"Courier"],
 StyleBox["expr",
  FontFamily->"Courier",
  FontSlant->"Italic"],
 StyleBox["]",
  FontFamily->"Courier"],
 " are exactly those of ",
 StyleBox["expr",
  FontFamily->"Courier",
  FontSlant->"Italic"],
 ". The density definition must be given independently:"
}], "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Options", "[", "DefInertHead", "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"LinearQ", "\[Rule]", "False"}], ",", 
   RowBox[{"ContractThrough", "\[Rule]", 
    RowBox[{"{", "}"}]}], ",", 
   RowBox[{"Master", "\[Rule]", "Null"}], ",", 
   RowBox[{"PrintAs", "\[Rule]", "Identity"}], ",", 
   RowBox[{"ProtectNewSymbol", "\[RuleDelayed]", "$ProtectNewSymbols"}], ",", 
   
   RowBox[{"DefInfo", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"\<\"inert head\"\>", ",", "\<\"\"\>"}], "}"}]}]}], 
  "}"}]], "Output"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{"Define", " ", "linear", " ", "inert", " ", "head"}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"DefInertHead", "[", 
     RowBox[{"Perturbation", ",", 
      RowBox[{"PrintAs", "->", "\"\<\[EmptyUpTriangle]\>\""}], ",", 
      RowBox[{"DefInfo", "\[Rule]", "False"}], ",", 
      RowBox[{"ContractThrough", "\[Rule]", 
       RowBox[{"{", "delta", "}"}]}], ",", 
      RowBox[{"LinearQ", "\[Rule]", "True"}]}], "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"Perturbation", " ", "has", " ", "two", " ", "arguments"}], ",", 
     " ", 
     RowBox[{
     "but", " ", "the", " ", "second", " ", "defaults", " ", "to", " ", 
      "1"}]}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Default", "[", 
      RowBox[{"Perturbation", ",", "2"}], "]"}], ":=", "1"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Perturbation", "[", 
      RowBox[{"expr_", ",", "0"}], "]"}], ":=", "expr"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Perturbation", "[", 
      RowBox[{"expr_", ",", "1"}], "]"}], ":=", 
     RowBox[{"Perturbation", "[", "expr", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Perturbation", " ", "does", " ", "not", " ", "affect", " ", "the", " ", 
     "density", " ", "character"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"WeightOf", "[", 
      RowBox[{"Perturbation", "[", 
       RowBox[{"expr_", ",", "_."}], "]"}], "]"}], "^:=", 
     RowBox[{"WeightOf", "[", "expr", "]"}]}], ";"}]}]}]], "Input",
 InitializationCell->True],

Cell["\<\
It acts as a derivative and commutes with covariant partial derivatives or \
derivatives of scalars. As suggested by Teake, we block perturbations on \
derivatives of scalar densities:\
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Perturbation", "[", 
    RowBox[{
     RowBox[{"_", "?", "ConstantQ"}], ",", "_."}], "]"}], ":=", "0"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Perturbation", "[", 
    RowBox[{
     RowBox[{"delta", "[", 
      RowBox[{"a_", ",", "b_"}], "]"}], ",", "_."}], "]"}], ":=", "0"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Perturbation", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"PD", "[", 
       RowBox[{"-", "a_"}], "]"}], "[", "expr_", "]"}], ",", "n_."}], "]"}], ":=", 
   RowBox[{
    RowBox[{"PD", "[", 
     RowBox[{"-", "a"}], "]"}], "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"expr", ",", "n"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Perturbation", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"cd_Symbol", "?", "CovDQ"}], "[", 
        RowBox[{"-", "a_"}], "]"}], "[", 
       RowBox[{"expr_", "?", "ScalarQ"}], "]"}], ",", "n_."}], "]"}], "/;", 
    RowBox[{"FreeQ", "[", 
     RowBox[{
      RowBox[{"WeightOf", "@", "expr"}], ",", 
      RowBox[{"WeightedWithBasis", "@", "cd"}]}], "]"}]}], ":=", 
   RowBox[{
    RowBox[{"cd", "[", 
     RowBox[{"-", "a"}], "]"}], "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"expr", ",", "n"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Perturbation", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"ParamD", "[", "ps__", "]"}], "[", "expr_", "]"}], ",", "n_."}],
     "]"}], ":=", 
   RowBox[{
    RowBox[{"ParamD", "[", "ps", "]"}], "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"expr", ",", "n"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Perturbation", "[", 
    RowBox[{
     RowBox[{"OverDot", "[", "expr_", "]"}], ",", "n_."}], "]"}], ":=", 
   RowBox[{"OverDot", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"expr", ",", "n"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Perturbation", "[", 
    RowBox[{
     RowBox[{"Scalar", "[", "expr_", "]"}], ",", "n_."}], "]"}], ":=", 
   RowBox[{"Scalar", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"expr", ",", "n"}], "]"}], "]"}]}], ";"}]}], "Input",
 InitializationCell->True],

Cell["\<\
It does not commute with covariant derivatives of general expressions:\
\>", "Text"],

Cell["Generalized Leibniz rule:", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Perturbation", "[", 
    RowBox[{"product_Times", ",", "n_."}], "]"}], ":=", 
   RowBox[{"LeibnizDistribute", "[", 
    RowBox[{"Perturbation", ",", "n", ",", "product", ",", "Plus"}], "]"}]}], 
  ";"}]], "Input",
 InitializationCell->True],

Cell["Extend to other algebra products:", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Perturbation", "[", 
    RowBox[{
     RowBox[{"product", ":", 
      RowBox[{
       RowBox[{"_", "?", "ProductQ"}], "[", "__", "]"}]}], ",", "n_."}], 
    "]"}], ":=", 
   RowBox[{"LeibnizDistribute", "[", 
    RowBox[{"Perturbation", ",", "n", ",", "product", ",", "Plus"}], "]"}]}], 
  ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{"Perturbation", "/:", 
   RowBox[{"Grade", "[", 
    RowBox[{
     RowBox[{"Perturbation", "[", 
      RowBox[{"expr_", ",", "n_."}], "]"}], ",", "prod_"}], "]"}], ":=", 
   RowBox[{"Grade", "[", 
    RowBox[{"expr", ",", "prod"}], "]"}]}], ";"}]], "Input",
 InitializationCell->True],

Cell["Perturbation of a scalar function:", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Perturbation", "[", 
    RowBox[{
     RowBox[{"expr", ":", 
      RowBox[{
       RowBox[{"_", "?", "ScalarFunctionQ"}], "[", "__", "]"}]}], ",", 
     "order_."}], "]"}], ":=", 
   RowBox[{"FaadiBruno", "[", 
    RowBox[{"expr", ",", "order"}], "]"}]}], ";"}]], "Input",
 InitializationCell->True],

Cell[TextData[{
 "Formatting (note the redundant check ?InertHeadQ to avoid problems with the \
new definition-ordering rules in ",
 StyleBox["Mathematica ",
  FontSlant->"Italic"],
 "6):"
}], "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"MakeBoxes", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Perturbation", "?", "InertHeadQ"}], "[", "expr_", "]"}], ",", 
     "StandardForm"}], "]"}], ":=", 
   RowBox[{"xAct`xTensor`Private`interpretbox", "[", 
    RowBox[{
     RowBox[{"Perturbation", "[", "expr", "]"}], ",", 
     RowBox[{"RowBox", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"PrintAs", "[", "Perturbation", "]"}], ",", "\"\<[\>\"", ",", 
        
        RowBox[{"MakeBoxes", "[", 
         RowBox[{"expr", ",", "StandardForm"}], "]"}], ",", "\"\<]\>\""}], 
       "}"}], "]"}]}], "]"}]}], ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"MakeBoxes", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Perturbation", "?", "InertHeadQ"}], "[", 
      RowBox[{"expr_", ",", "n_"}], "]"}], ",", "StandardForm"}], "]"}], ":=", 
   RowBox[{"xAct`xTensor`Private`interpretbox", "[", 
    RowBox[{
     RowBox[{"Perturbation", "[", 
      RowBox[{"expr", ",", "n"}], "]"}], ",", 
     RowBox[{"RowBox", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"SuperscriptBox", "[", 
         RowBox[{
          RowBox[{"PrintAs", "[", "Perturbation", "]"}], ",", 
          RowBox[{"ToString", "[", "n", "]"}]}], "]"}], ",", "\"\<[\>\"", ",", 
        RowBox[{"MakeBoxes", "[", 
         RowBox[{"expr", ",", "StandardForm"}], "]"}], ",", "\"\<]\>\""}], 
       "}"}], "]"}]}], "]"}]}], ";"}]], "Input",
 InitializationCell->True],

Cell["Perturbations are joined together:", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Perturbation", "[", 
    RowBox[{
     RowBox[{"Perturbation", "[", 
      RowBox[{"expr_", ",", "n_."}], "]"}], ",", "m_."}], "]"}], ":=", 
   RowBox[{"Perturbation", "[", 
    RowBox[{"expr", ",", 
     RowBox[{"n", "+", "m"}]}], "]"}]}], ";"}]], "Input",
 InitializationCell->True],

Cell["Finally:", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"Perturbation", ",", 
    RowBox[{"{", 
     RowBox[{"1", ",", "2"}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "Perturbation", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell["Examples:", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Perturbation", "[", 
  RowBox[{
   RowBox[{"a", " ", "b", " ", "c"}], ",", "10"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"90", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "8"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 8],
    Editable->False]}], "+", 
  RowBox[{"10", " ", "c", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "9"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 9],
    Editable->False]}], "+", 
  RowBox[{"10", " ", "b", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "9"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 9],
    Editable->False]}], "+", 
  RowBox[{"b", " ", "c", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "10"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 10],
    Editable->False]}], "+", 
  RowBox[{"360", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "7"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 7],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 2],
    Editable->False]}], "+", 
  RowBox[{"45", " ", "c", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "8"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 8],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 2],
    Editable->False]}], "+", 
  RowBox[{"840", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 6],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 3],
    Editable->False]}], "+", 
  RowBox[{"120", " ", "c", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "7"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 7],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 3],
    Editable->False]}], "+", 
  RowBox[{"1260", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 5],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 4],
    Editable->False]}], "+", 
  RowBox[{"210", " ", "c", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 6],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 4],
    Editable->False]}], "+", 
  RowBox[{"1260", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 4],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 5],
    Editable->False]}], "+", 
  RowBox[{"252", " ", "c", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 5],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 5],
    Editable->False]}], "+", 
  RowBox[{"840", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 3],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 6],
    Editable->False]}], "+", 
  RowBox[{"210", " ", "c", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 4],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 6],
    Editable->False]}], "+", 
  RowBox[{"360", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "7"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 7],
    Editable->False]}], "+", 
  RowBox[{"120", " ", "c", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 3],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "7"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 7],
    Editable->False]}], "+", 
  RowBox[{"90", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "8"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 8],
    Editable->False]}], "+", 
  RowBox[{"45", " ", "c", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "8"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 8],
    Editable->False]}], "+", 
  RowBox[{"10", " ", "c", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "9"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 9],
    Editable->False]}], "+", 
  RowBox[{"10", " ", "a", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "9"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 9],
    Editable->False]}], "+", 
  RowBox[{"a", " ", "c", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "10"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 10],
    Editable->False]}], "+", 
  RowBox[{"360", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "7"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 7],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 2],
    Editable->False]}], "+", 
  RowBox[{"45", " ", "b", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "8"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 8],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 2],
    Editable->False]}], "+", 
  RowBox[{"1260", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 6],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 2],
    Editable->False]}], "+", 
  RowBox[{"2520", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 5],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 3],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 2],
    Editable->False]}], "+", 
  RowBox[{"3150", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 4],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 4],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 2],
    Editable->False]}], "+", 
  RowBox[{"2520", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 3],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 5],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 2],
    Editable->False]}], "+", 
  RowBox[{"1260", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 6],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 2],
    Editable->False]}], "+", 
  RowBox[{"360", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "7"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 7],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 2],
    Editable->False]}], "+", 
  RowBox[{"45", " ", "a", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "8"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 8],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 2],
    Editable->False]}], "+", 
  RowBox[{"840", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 6],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 3],
    Editable->False]}], "+", 
  RowBox[{"120", " ", "b", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "7"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 7],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 3],
    Editable->False]}], "+", 
  RowBox[{"2520", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 5],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 3],
    Editable->False]}], "+", 
  RowBox[{"4200", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 4],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 3],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 3],
    Editable->False]}], "+", 
  RowBox[{"4200", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 3],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 4],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 3],
    Editable->False]}], "+", 
  RowBox[{"2520", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 5],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 3],
    Editable->False]}], "+", 
  RowBox[{"840", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 6],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 3],
    Editable->False]}], "+", 
  RowBox[{"120", " ", "a", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "7"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 7],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 3],
    Editable->False]}], "+", 
  RowBox[{"1260", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 5],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 4],
    Editable->False]}], "+", 
  RowBox[{"210", " ", "b", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 6],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 4],
    Editable->False]}], "+", 
  RowBox[{"3150", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 4],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 4],
    Editable->False]}], "+", 
  RowBox[{"4200", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 3],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 3],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 4],
    Editable->False]}], "+", 
  RowBox[{"3150", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 4],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 4],
    Editable->False]}], "+", 
  RowBox[{"1260", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 5],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 4],
    Editable->False]}], "+", 
  RowBox[{"210", " ", "a", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 6],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 4],
    Editable->False]}], "+", 
  RowBox[{"1260", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 4],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 5],
    Editable->False]}], "+", 
  RowBox[{"252", " ", "b", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 5],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 5],
    Editable->False]}], "+", 
  RowBox[{"2520", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 3],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 5],
    Editable->False]}], "+", 
  RowBox[{"2520", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 3],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 5],
    Editable->False]}], "+", 
  RowBox[{"1260", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 4],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 5],
    Editable->False]}], "+", 
  RowBox[{"252", " ", "a", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 5],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 5],
    Editable->False]}], "+", 
  RowBox[{"840", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 3],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 6],
    Editable->False]}], "+", 
  RowBox[{"210", " ", "b", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 4],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 6],
    Editable->False]}], "+", 
  RowBox[{"1260", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 6],
    Editable->False]}], "+", 
  RowBox[{"840", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 3],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 6],
    Editable->False]}], "+", 
  RowBox[{"210", " ", "a", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 4],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 6],
    Editable->False]}], "+", 
  RowBox[{"360", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "7"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 7],
    Editable->False]}], "+", 
  RowBox[{"120", " ", "b", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 3],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "7"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 7],
    Editable->False]}], "+", 
  RowBox[{"360", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "7"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 7],
    Editable->False]}], "+", 
  RowBox[{"120", " ", "a", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 3],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "7"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 7],
    Editable->False]}], "+", 
  RowBox[{"90", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "8"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 8],
    Editable->False]}], "+", 
  RowBox[{"45", " ", "b", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "8"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 8],
    Editable->False]}], "+", 
  RowBox[{"45", " ", "a", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "8"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 8],
    Editable->False]}], "+", 
  RowBox[{"10", " ", "b", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "a", "]"}],
     AutoSpacing->False],
    Perturbation[a],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "9"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 9],
    Editable->False]}], "+", 
  RowBox[{"10", " ", "a", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "b", "]"}],
     AutoSpacing->False],
    Perturbation[b],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "9"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 9],
    Editable->False]}], "+", 
  RowBox[{"a", " ", "b", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "10"], "[", "c", "]"}],
     AutoSpacing->False],
    Perturbation[c, 10],
    Editable->False]}]}]], "Output"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Perturbation", "[", 
  RowBox[{
   RowBox[{"Sin", "[", "x", "]"}], ",", "5"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    InterpretationBox[
     StyleBox["Cos",
      AutoSpacing->False],
     Cos,
     Editable->False], "[", "x", "]"}], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x, 5],
    Editable->False]}], "-", 
  RowBox[{"10", " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Cos",
      AutoSpacing->False],
     Cos,
     Editable->False], "[", "x", "]"}], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x, 3],
    Editable->False], " ", 
   SuperscriptBox[
    RowBox[{"Scalar", "[", 
     InterpretationBox[
      StyleBox[
       RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
       AutoSpacing->False],
      Perturbation[x],
      Editable->False], "]"}], "2"]}], "+", 
  RowBox[{
   RowBox[{
    InterpretationBox[
     StyleBox["Cos",
      AutoSpacing->False],
     Cos,
     Editable->False], "[", "x", "]"}], " ", 
   SuperscriptBox[
    RowBox[{"Scalar", "[", 
     InterpretationBox[
      StyleBox[
       RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
       AutoSpacing->False],
      Perturbation[x],
      Editable->False], "]"}], "5"]}], "-", 
  RowBox[{"15", " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Cos",
      AutoSpacing->False],
     Cos,
     Editable->False], "[", "x", "]"}], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x],
    Editable->False], " ", 
   SuperscriptBox[
    RowBox[{"Scalar", "[", 
     InterpretationBox[
      StyleBox[
       RowBox[{
        SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "x", "]"}],
       AutoSpacing->False],
      Perturbation[x, 2],
      Editable->False], "]"}], "2"]}], "-", 
  RowBox[{"10", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x, 3],
    Editable->False], " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Sin",
      AutoSpacing->False],
     Sin,
     Editable->False], "[", "x", "]"}]}], "-", 
  RowBox[{"5", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x, 4],
    Editable->False], " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Sin",
      AutoSpacing->False],
     Sin,
     Editable->False], "[", "x", "]"}]}], "+", 
  RowBox[{"10", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x, 2],
    Editable->False], " ", 
   SuperscriptBox[
    RowBox[{"Scalar", "[", 
     InterpretationBox[
      StyleBox[
       RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
       AutoSpacing->False],
      Perturbation[x],
      Editable->False], "]"}], "3"], " ", 
   RowBox[{
    InterpretationBox[
     StyleBox["Sin",
      AutoSpacing->False],
     Sin,
     Editable->False], "[", "x", "]"}]}]}]], "Output"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Perturbation", "[", 
  RowBox[{
   RowBox[{"Power", "[", 
    RowBox[{"x", ",", "3"}], "]"}], ",", "6"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"360", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x, 3],
    Editable->False]}], "+", 
  RowBox[{"90", " ", "x", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x, 2],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x, 4],
    Editable->False]}], "+", 
  RowBox[{"36", " ", "x", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x],
    Editable->False], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x, 5],
    Editable->False]}], "+", 
  RowBox[{"3", " ", 
   SuperscriptBox["x", "2"], " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x, 6],
    Editable->False]}], "+", 
  RowBox[{"90", " ", 
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x, 4],
    Editable->False], " ", 
   SuperscriptBox[
    RowBox[{"Scalar", "[", 
     InterpretationBox[
      StyleBox[
       RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
       AutoSpacing->False],
      Perturbation[x],
      Editable->False], "]"}], "2"]}], "+", 
  RowBox[{"90", " ", 
   SuperscriptBox[
    RowBox[{"Scalar", "[", 
     InterpretationBox[
      StyleBox[
       RowBox[{
        SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "x", "]"}],
       AutoSpacing->False],
      Perturbation[x, 2],
      Editable->False], "]"}], "3"]}], "+", 
  RowBox[{"60", " ", "x", " ", 
   SuperscriptBox[
    RowBox[{"Scalar", "[", 
     InterpretationBox[
      StyleBox[
       RowBox[{
        SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "x", "]"}],
       AutoSpacing->False],
      Perturbation[x, 3],
      Editable->False], "]"}], "2"]}]}]], "Output"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Perturbation", "[", 
  RowBox[{
   RowBox[{"Power", "[", 
    RowBox[{"x", ",", 
     RowBox[{"1", "/", "2"}]}], "]"}], ",", "6"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{
  FractionBox[
   RowBox[{"45", " ", 
    InterpretationBox[
     StyleBox[
      RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
      AutoSpacing->False],
     Perturbation[x],
     Editable->False], " ", 
    InterpretationBox[
     StyleBox[
      RowBox[{
       SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "x", "]"}],
      AutoSpacing->False],
     Perturbation[x, 2],
     Editable->False], " ", 
    InterpretationBox[
     StyleBox[
      RowBox[{
       SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "x", "]"}],
      AutoSpacing->False],
     Perturbation[x, 3],
     Editable->False]}], 
   RowBox[{"2", " ", 
    SuperscriptBox["x", 
     RowBox[{"5", "/", "2"}]]}]], "-", 
  FractionBox[
   RowBox[{"15", " ", 
    InterpretationBox[
     StyleBox[
      RowBox[{
       SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "x", "]"}],
      AutoSpacing->False],
     Perturbation[x, 2],
     Editable->False], " ", 
    InterpretationBox[
     StyleBox[
      RowBox[{
       SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "x", "]"}],
      AutoSpacing->False],
     Perturbation[x, 4],
     Editable->False]}], 
   RowBox[{"4", " ", 
    SuperscriptBox["x", 
     RowBox[{"3", "/", "2"}]]}]], "-", 
  FractionBox[
   RowBox[{"3", " ", 
    InterpretationBox[
     StyleBox[
      RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
      AutoSpacing->False],
     Perturbation[x],
     Editable->False], " ", 
    InterpretationBox[
     StyleBox[
      RowBox[{
       SuperscriptBox["\[EmptyUpTriangle]", "5"], "[", "x", "]"}],
      AutoSpacing->False],
     Perturbation[x, 5],
     Editable->False]}], 
   RowBox[{"2", " ", 
    SuperscriptBox["x", 
     RowBox[{"3", "/", "2"}]]}]], "+", 
  FractionBox[
   InterpretationBox[
    StyleBox[
     RowBox[{
      SuperscriptBox["\[EmptyUpTriangle]", "6"], "[", "x", "]"}],
     AutoSpacing->False],
    Perturbation[x, 6],
    Editable->False], 
   RowBox[{"2", " ", 
    SqrtBox["x"]}]], "+", 
  FractionBox[
   RowBox[{"45", " ", 
    InterpretationBox[
     StyleBox[
      RowBox[{
       SuperscriptBox["\[EmptyUpTriangle]", "4"], "[", "x", "]"}],
      AutoSpacing->False],
     Perturbation[x, 4],
     Editable->False], " ", 
    SuperscriptBox[
     RowBox[{"Scalar", "[", 
      InterpretationBox[
       StyleBox[
        RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
        AutoSpacing->False],
       Perturbation[x],
       Editable->False], "]"}], "2"]}], 
   RowBox[{"8", " ", 
    SuperscriptBox["x", 
     RowBox[{"5", "/", "2"}]]}]], "-", 
  FractionBox[
   RowBox[{"75", " ", 
    InterpretationBox[
     StyleBox[
      RowBox[{
       SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "x", "]"}],
      AutoSpacing->False],
     Perturbation[x, 3],
     Editable->False], " ", 
    SuperscriptBox[
     RowBox[{"Scalar", "[", 
      InterpretationBox[
       StyleBox[
        RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
        AutoSpacing->False],
       Perturbation[x],
       Editable->False], "]"}], "3"]}], 
   RowBox[{"4", " ", 
    SuperscriptBox["x", 
     RowBox[{"7", "/", "2"}]]}]], "+", 
  FractionBox[
   RowBox[{"1575", " ", 
    InterpretationBox[
     StyleBox[
      RowBox[{
       SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "x", "]"}],
      AutoSpacing->False],
     Perturbation[x, 2],
     Editable->False], " ", 
    SuperscriptBox[
     RowBox[{"Scalar", "[", 
      InterpretationBox[
       StyleBox[
        RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
        AutoSpacing->False],
       Perturbation[x],
       Editable->False], "]"}], "4"]}], 
   RowBox[{"32", " ", 
    SuperscriptBox["x", 
     RowBox[{"9", "/", "2"}]]}]], "-", 
  FractionBox[
   RowBox[{"945", " ", 
    SuperscriptBox[
     RowBox[{"Scalar", "[", 
      InterpretationBox[
       StyleBox[
        RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
        AutoSpacing->False],
       Perturbation[x],
       Editable->False], "]"}], "6"]}], 
   RowBox[{"64", " ", 
    SuperscriptBox["x", 
     RowBox[{"11", "/", "2"}]]}]], "-", 
  FractionBox[
   RowBox[{"675", " ", 
    SuperscriptBox[
     RowBox[{"Scalar", "[", 
      InterpretationBox[
       StyleBox[
        RowBox[{"\[EmptyUpTriangle]", "[", "x", "]"}],
        AutoSpacing->False],
       Perturbation[x],
       Editable->False], "]"}], "2"], " ", 
    SuperscriptBox[
     RowBox[{"Scalar", "[", 
      InterpretationBox[
       StyleBox[
        RowBox[{
         SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "x", "]"}],
        AutoSpacing->False],
       Perturbation[x, 2],
       Editable->False], "]"}], "2"]}], 
   RowBox[{"16", " ", 
    SuperscriptBox["x", 
     RowBox[{"7", "/", "2"}]]}]], "+", 
  FractionBox[
   RowBox[{"45", " ", 
    SuperscriptBox[
     RowBox[{"Scalar", "[", 
      InterpretationBox[
       StyleBox[
        RowBox[{
         SuperscriptBox["\[EmptyUpTriangle]", "2"], "[", "x", "]"}],
        AutoSpacing->False],
       Perturbation[x, 2],
       Editable->False], "]"}], "3"]}], 
   RowBox[{"8", " ", 
    SuperscriptBox["x", 
     RowBox[{"5", "/", "2"}]]}]], "-", 
  FractionBox[
   RowBox[{"5", " ", 
    SuperscriptBox[
     RowBox[{"Scalar", "[", 
      InterpretationBox[
       StyleBox[
        RowBox[{
         SuperscriptBox["\[EmptyUpTriangle]", "3"], "[", "x", "]"}],
        AutoSpacing->False],
       Perturbation[x, 3],
       Editable->False], "]"}], "2"]}], 
   RowBox[{"2", " ", 
    SuperscriptBox["x", 
     RowBox[{"3", "/", "2"}]]}]]}]], "Output"]
}, Open  ]],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"General", "::", "canonpert"}], "=", 
   "\"\<ToCanonical on Perturbation may incorrectly change index \
characters.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"xAct`xTensor`Private`Identify", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"expr_", ",", "n_."}], "]"}], "]"}], ":=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{
         "UseMetricOnVBundle", "/.", "xAct`xTensor`Private`$TCOptions"}], 
         ")"}], "=!=", "None"}], ",", 
       RowBox[{"Message", "[", 
        RowBox[{"ToCanonical", "::", "canonpert"}], "]"}]}], "]"}], ";", 
     RowBox[{"xAct`xTensor`Private`addhead1A", "[", 
      RowBox[{
       RowBox[{"Perturbation", "[", 
        RowBox[{"expr", ",", "n"}], "]"}], ",", 
       RowBox[{
        RowBox[{"Perturbation", "[", 
         RowBox[{"#", ",", "n"}], "]"}], "&"}], ",", "expr"}], "]"}]}], 
    ")"}]}], ";"}]}], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["3.4. Perturbed", "Subsubsection"],

Cell[TextData[{
 "This function gives the total perturbation up to a given order. It is \
constructed in terms of ",
 StyleBox["Perturbation",
  FontFamily->"Courier"],
 ", but could equally well be given in terms of ",
 StyleBox["GeneralPerturbation",
  FontFamily->"Courier"],
 ". Note the factor 1/n!"
}], "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"?", "Perturbed"}]], "Input"],

Cell[BoxData["\<\"Perturbed[expr, n] returns the expansion of expr perturbed \
up to n-th order, using $PerturbationParameter.\"\>"], "Print",
 CellTags->"Info3422985539-3771734"]
}, Open  ]],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Perturbed", "[", 
    RowBox[{"expr_", ",", "order_Integer"}], "]"}], ":=", 
   RowBox[{"Sum", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"$PerturbationParameter", "^", "n"}], " ", 
      RowBox[{
       RowBox[{"Perturbation", "[", 
        RowBox[{"expr", ",", "n"}], "]"}], "/", 
       RowBox[{"n", "!"}]}]}], ",", 
     RowBox[{"{", 
      RowBox[{"n", ",", "0", ",", "order"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"Perturbed", ",", "2"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "Perturbed", "]"}], ";"}]}], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["3.5. ExpandPerturbation", "Subsubsection"],

Cell["\<\
This function knows nothing at the beginning. It must be trained little by \
little adding information to ExpandPerturbation1:\
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "ExpandPerturbation", "]"}], ":=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"SeparateMetric", "\[Rule]", "True"}], ",", 
     RowBox[{"OverDerivatives", "\[Rule]", "True"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExpandPerturbation", "[", 
    RowBox[{"expr_", ",", 
     RowBox[{"options___", "?", "OptionQ"}]}], "]"}], ":=", 
   RowBox[{"expr", "/.", 
    RowBox[{"expr1_Perturbation", "\[RuleDelayed]", 
     RowBox[{"ExpandPerturbation1", "[", 
      RowBox[{"expr1", ",", "options"}], "]"}]}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExpandPerturbation", "[", 
    RowBox[{"expr_", ",", 
     RowBox[{"tensor_Symbol", "?", "xTensorQ"}], ",", 
     RowBox[{"options___", "?", "OptionQ"}]}], "]"}], ":=", 
   RowBox[{"expr", "/.", 
    RowBox[{
     RowBox[{"expr1", ":", 
      RowBox[{"Perturbation", "[", 
       RowBox[{
        RowBox[{"tensor", "[", "___", "]"}], ",", "n_."}], "]"}]}], 
     "\[RuleDelayed]", 
     RowBox[{"ExpandPerturbation1", "[", 
      RowBox[{"expr1", ",", "options"}], "]"}]}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExpandPerturbation", "[", 
    RowBox[{"expr_", ",", 
     RowBox[{"list", ":", 
      RowBox[{"{", 
       RowBox[{"___Symbol", "?", "xTensorQ"}], "}"}]}], ",", 
     RowBox[{"options___", "?", "OptionQ"}]}], "]"}], ":=", 
   RowBox[{"Fold", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"ExpandPerturbation", "[", 
       RowBox[{"#1", ",", "#2", ",", "options"}], "]"}], "&"}], ",", "expr", 
     ",", "list"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"ExpandPerturbation", ",", 
    RowBox[{"{", 
     RowBox[{"1", ",", "Infinity"}], "}"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "ExpandPerturbation", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell["\<\
General definition, in use when none of the particular definitions work:\
\>", "Text"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"?", "ChangeCovD"}]], "Input"],

Cell[BoxData["\<\"ChangeCovD[expr, covd1, covd2] changes any instance of the \
covariant derivative covd1 in expr into a covariant derivative covd2 and \
Christoffel tensors relating both connections. The second argument is \
listable. ChangeCovD[expr, covd1] is converted into ChangeCovD[expr, covd1, \
PD]. ChangeCovD[expr] is converted into ChangeCovD[expr, $CovDs].\"\>"], \
"Print",
 CellTags->"Info3422985543-2313958"]
}, Open  ]],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ExpandPerturbation1", "[", 
    RowBox[{
     RowBox[{"Perturbation", "[", 
      RowBox[{"expr_", ",", "n_."}], "]"}], ",", "options___"}], "]"}], ":=", 
   
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"sepmetric", ",", "od", ",", "tmp"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"sepmetric", ",", "od"}], "}"}], "=", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"SeparateMetric", ",", "OverDerivatives"}], "}"}], "/.", 
         RowBox[{"CheckOptions", "[", "options", "]"}]}], "/.", 
        RowBox[{"Options", "[", "ExpandPerturbation", "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Separate", " ", "metrics"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"tmp", "=", 
       RowBox[{"Perturbation", "[", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{"sepmetric", ",", 
           RowBox[{
            RowBox[{"SeparateMetric", "[", "]"}], "[", "expr", "]"}], ",", 
           "expr"}], "]"}], ",", "n"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", "Derivatives", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{"od", ",", 
        RowBox[{"tmp", "=", 
         RowBox[{"tmp", "/.", 
          RowBox[{
           RowBox[{"expr1", ":", 
            RowBox[{"HoldPattern", "[", 
             RowBox[{"Perturbation", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"_Symbol", "?", "CovDQ"}], "[", "_", "]"}], "[", 
                 "_", "]"}], "|", 
                RowBox[{
                 RowBox[{"LieD", "[", "_", "]"}], "[", "_", "]"}], "|", 
                RowBox[{
                 RowBox[{"Bracket", "[", 
                  RowBox[{"_", ",", "_"}], "]"}], "[", "_", "]"}]}], ",", 
               "_."}], "]"}], "]"}]}], "\[RuleDelayed]", 
           RowBox[{"ExpandPerturbationDer", "[", "expr1", "]"}]}]}]}]}], 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", "Reexpand", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"tmp", "=!=", 
         RowBox[{"Perturbation", "[", 
          RowBox[{"expr", ",", "n"}], "]"}]}], ",", 
        RowBox[{"tmp", "=", 
         RowBox[{"ExpandPerturbation", "[", 
          RowBox[{"tmp", ",", "options"}], "]"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Return", " ", "result"}], " ", "*)"}], "\[IndentingNewLine]", 
      "tmp"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExpandPerturbation1", "[", 
    RowBox[{"expr_", ",", "options___"}], "]"}], ":=", "expr"}], 
  ";"}]}], "Input",
 InitializationCell->True],

Cell["For backwards compatibility:", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"GeneralPerturbation", "[", 
    RowBox[{"expr_", ",", 
     RowBox[{"order_:", "1"}]}], "]"}], ":=", 
   RowBox[{"ExpandPerturbation", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"expr", ",", "order"}], "]"}], "]"}]}], ";"}]], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["3.6. Perturbation of derivatives", "Subsubsection"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"ExpandPerturbationDer", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"cd_Symbol", "?", "CovDQ"}], "[", 
        RowBox[{"-", "a_"}], "]"}], "[", "expr_", "]"}], ",", "n_."}], "]"}], 
    "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"cd", "[", 
      RowBox[{"-", "a"}], "]"}], "[", 
     RowBox[{"Perturbation", "[", 
      RowBox[{"expr", ",", "n"}], "]"}], "]"}], "+", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"vbundles", "=", 
        RowBox[{"VBundlesOfCovD", "[", "cd", "]"}]}], "}"}], ",", 
      RowBox[{
       RowBox[{"Plus", "@@", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{"xAct`xTensor`Private`addChristoffel", "[", 
           RowBox[{"expr", ",", 
            RowBox[{"-", "a"}]}], "]"}], ",", 
          RowBox[{"xAct`xTensor`Private`selecton", "[", 
           RowBox[{
            RowBox[{"Select", "[", 
             RowBox[{
              RowBox[{"FindFreeIndices", "[", "expr", "]"}], ",", "AIndexQ"}],
              "]"}], ",", "vbundles"}], "]"}]}], "]"}]}], "/.", 
       RowBox[{
        RowBox[{"expr1_", " ", 
         RowBox[{"xAct`xTensor`Private`CHR", "[", "indices__", "]"}]}], 
        "\[RuleDelayed]", 
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"chr", "=", 
            RowBox[{
             RowBox[{"Christoffel", "[", "cd", "]"}], "[", "indices", "]"}]}],
            "}"}], ",", 
          RowBox[{
           RowBox[{"Perturbation", "[", 
            RowBox[{
             RowBox[{"expr1", " ", "chr"}], ",", "n"}], "]"}], "-", 
           RowBox[{"chr", " ", 
            RowBox[{"Perturbation", "[", 
             RowBox[{"expr1", ",", "n"}], "]"}]}]}]}], "]"}]}]}]}], "]"}], 
    "+", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"basis", "=", 
         RowBox[{"WeightedWithBasis", "[", "cd", "]"}]}], ",", 
        RowBox[{"dummy", "=", 
         RowBox[{"DummyIn", "@", 
          RowBox[{"VBundleOfIndex", "[", "a", "]"}]}]}], ",", "weight"}], 
       "}"}], ",", 
      RowBox[{
       RowBox[{"weight", "=", 
        RowBox[{"WeightOf", "[", 
         RowBox[{"expr", ",", "basis"}], "]"}]}], ";", "\[IndentingNewLine]", 
       
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"weight", "===", "0"}], ",", "0", ",", 
         RowBox[{"weight", " ", 
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"chr", "=", 
              RowBox[{
               RowBox[{"Christoffel", "[", 
                RowBox[{"cd", ",", 
                 RowBox[{"xAct`xCoba`PDOfBasis", "[", "basis", "]"}]}], "]"}],
                "[", 
               RowBox[{"dummy", ",", 
                RowBox[{"-", "a"}], ",", 
                RowBox[{"-", "dummy"}]}], "]"}]}], "}"}], ",", 
            RowBox[{
             RowBox[{"-", 
              RowBox[{"Perturbation", "[", 
               RowBox[{
                RowBox[{"chr", " ", "expr"}], ",", "n"}], "]"}]}], "+", 
             RowBox[{"chr", " ", 
              RowBox[{"Perturbation", "[", 
               RowBox[{"expr", ",", "n"}], "]"}]}]}]}], "]"}]}]}], "]"}]}]}], 
     "]"}]}]}], ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"ExpandPerturbationDer", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"LieD", "[", "v_", "]"}], "[", "expr_", "]"}], ",", "n_."}], 
     "]"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "lieD", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"LeibnizDistribute", "[", 
       RowBox[{"Perturbation", ",", "n", ",", 
        RowBox[{"lieD", "[", 
         RowBox[{"v", ",", "expr"}], "]"}], ",", "Plus"}], "]"}], "/.", 
      RowBox[{
       RowBox[{"lieD", "[", 
        RowBox[{"V_", ",", "EXPR_"}], "]"}], "\[RuleDelayed]", 
       RowBox[{
        RowBox[{"LieD", "[", "V", "]"}], "[", "EXPR", "]"}]}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"ExpandPerturbationDer", "[", 
    RowBox[{
     RowBox[{"Perturbation", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Bracket", "[", 
         RowBox[{"v1_", ",", "v2_"}], "]"}], "[", "a_Symbol", "]"}], ",", 
       "n_."}], "]"}], ",", "options___"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "bracket", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"LeibnizDistribute", "[", 
       RowBox[{"Perturbation", ",", "n", ",", 
        RowBox[{
         RowBox[{"bracket", "[", "a", "]"}], "[", 
         RowBox[{"v1", ",", "v2"}], "]"}], ",", "Plus"}], "]"}], "/.", 
      RowBox[{
       RowBox[{
        RowBox[{"bracket", "[", "A_", "]"}], "[", 
        RowBox[{"V1_", ",", "V2_"}], "]"}], "\[RuleDelayed]", 
       RowBox[{
        RowBox[{"Bracket", "[", 
         RowBox[{"V1", ",", "V2"}], "]"}], "[", "A", "]"}]}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["3.7. PerturbationOrder", "Subsubsection"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"homorder", "[", "list_List", "]"}], ":=", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Length", "[", 
       RowBox[{"Union", "[", "list", "]"}], "]"}], "===", "1"}], ",", 
     RowBox[{"First", "[", "list", "]"}], ",", "list"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PerturbationOrder", "[", "expr_Times", "]"}], ":=", 
   RowBox[{"Apply", "[", 
    RowBox[{"Plus", ",", 
     RowBox[{"Map", "[", 
      RowBox[{"PerturbationOrder", ",", 
       RowBox[{"List", "@@", "expr"}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PerturbationOrder", "[", "expr_Plus", "]"}], ":=", 
   RowBox[{"homorder", "@", 
    RowBox[{"Map", "[", 
     RowBox[{"PerturbationOrder", ",", 
      RowBox[{"List", "@@", "expr"}]}], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PerturbationOrder", "[", 
    RowBox[{"Power", "[", 
     RowBox[{"expr_", ",", "n_"}], "]"}], "]"}], ":=", 
   RowBox[{"n", " ", 
    RowBox[{"PerturbationOrder", "[", "expr", "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PerturbationOrder", "[", 
    RowBox[{"Perturbation", "[", 
     RowBox[{"expr_", ",", "n_."}], "]"}], "]"}], ":=", "n"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PerturbationOrder", "[", 
    RowBox[{
     RowBox[{"_", "?", "FirstDerQ"}], "[", "expr_", "]"}], "]"}], ":=", 
   RowBox[{"PerturbationOrder", "[", "expr", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PerturbationOrder", "[", "expr_", "]"}], ":=", "0"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"PerturbationOrder", ",", "1"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "PerturbationOrder", "]"}], ";"}]}], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["3.8. GaugeChange", "Subsubsection"],

Cell["\<\
Return perturbative expression in a different gauge. Background quantities \
are not changed. Nothing happens on inert heads.\
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"GaugeChange", "[", 
    RowBox[{"pert_Plus", ",", "gen_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"GaugeChange", "[", 
      RowBox[{"#", ",", "gen"}], "]"}], "&"}], "/@", "pert"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GaugeChange", "[", 
    RowBox[{"pert_Times", ",", "gen_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"GaugeChange", "[", 
      RowBox[{"#", ",", "gen"}], "]"}], "&"}], "/@", "pert"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GaugeChange", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"func_Symbol", "?", "ScalarFunction"}], "[", "args__", "]"}], 
     ",", "gen_"}], "]"}], ":=", 
   RowBox[{"Apply", "[", 
    RowBox[{"func", ",", 
     RowBox[{
      RowBox[{
       RowBox[{"GaugeChange", "[", 
        RowBox[{"#", ",", "gen"}], "]"}], "&"}], "/@", 
      RowBox[{"{", "args", "}"}]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GaugeChange", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"Scalar", "[", "pert_", "]"}], "^", 
      RowBox[{"Optional", "[", "n_Integer", "]"}]}], ",", "gen_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"Scalar", "[", 
     RowBox[{"xAct`xPert`GaugeChange", "[", 
      RowBox[{"pert", ",", "gen"}], "]"}], "]"}], "^", "n"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"GaugeChange", "[", 
    RowBox[{"expr_", ",", "gen_"}], "]"}], ":=", 
   RowBox[{"GaugeChange", "[", 
    RowBox[{"expr", ",", "gen", ",", 
     RowBox[{"PerturbationOrder", "[", "expr", "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GaugeChange", "[", 
    RowBox[{"expr_", ",", "gen_", ",", "0"}], "]"}], ":=", "expr"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GaugeChange", "[", 
    RowBox[{"expr_Perturbation", ",", "gen_", ",", "n_"}], "]"}], ":=", 
   RowBox[{"Bruni", "[", 
    RowBox[{"expr", ",", "gen", ",", "n"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GaugeChange", "[", 
    RowBox[{"expr_", ",", "gen_", ",", "n_"}], "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"sexpr", "=", 
       RowBox[{
        RowBox[{"SeparateMetric", "[", "]"}], "[", "expr", "]"}]}], "}"}], 
     ",", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"expr", "===", "sexpr"}], ",", 
       RowBox[{"Bruni", "[", 
        RowBox[{"expr", ",", "gen", ",", "n"}], "]"}], ",", 
       RowBox[{"GaugeChange", "[", 
        RowBox[{"sexpr", ",", "gen"}], "]"}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Bruni", "[", 
    RowBox[{"expr_", ",", "gen_", ",", "n_"}], "]"}], ":=", 
   RowBox[{"expr", "+", 
    RowBox[{"Expand", "@", 
     RowBox[{"Sum", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"n", "!"}], "/", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"n", "-", "m"}], ")"}], "!"}]}], "\[IndentingNewLine]", 
        RowBox[{"Apply", "[", 
         RowBox[{"Plus", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"BruniTerm", "[", 
             RowBox[{
              RowBox[{"Perturbation", "[", 
               RowBox[{"expr", ",", 
                RowBox[{"-", "m"}]}], "]"}], ",", "gen", ",", "#"}], "]"}], 
            "&"}], "/@", 
           RowBox[{"FoldedPartitions", "[", "m", "]"}]}]}], "]"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"m", ",", "1", ",", "n"}], "}"}]}], "]"}]}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetNumberOfArguments", "[", 
   RowBox[{"GaugeChange", ",", 
    RowBox[{"{", 
     RowBox[{"2", ",", "3"}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Protect", "[", "GaugeChange", "]"}], ";"}]}], "Input",
 InitializationCell->True],

Cell["Single term in Bruni's formula:", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"BruniTerm", "[", 
    RowBox[{"expr_", ",", "gen_", ",", "partition_"}], "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"dummy", "=", 
        RowBox[{"DummyIn", "@", 
         RowBox[{"Last", "@", 
          RowBox[{"SlotsOfTensor", "[", "gen", "]"}]}]}]}], ",", 
       RowBox[{"range", "=", 
        RowBox[{"Range", "@", 
         RowBox[{"Length", "@", "partition"}]}]}]}], "}"}], ",", 
     RowBox[{
      RowBox[{
       RowBox[{"1", "/", 
        RowBox[{"Inner", "[", 
         RowBox[{"Power", ",", 
          RowBox[{"Factorial", "[", "range", "]"}], ",", "partition", ",", 
          "Times"}], "]"}]}], "/", 
       RowBox[{"Times", "@@", 
        RowBox[{"Factorial", "[", "partition", "]"}]}]}], 
      RowBox[{"Fold", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Nest", "[", 
          RowBox[{
           RowBox[{"LieD", "[", 
            RowBox[{"gen", "[", 
             RowBox[{
              RowBox[{"LI", "[", 
               RowBox[{"First", "@", "#2"}], "]"}], ",", "dummy"}], "]"}], 
            "]"}], ",", "#1", ",", 
           RowBox[{"Last", "@", "#2"}]}], "]"}], "&"}], ",", "expr", ",", 
        RowBox[{"Reverse", "@", 
         RowBox[{"Transpose", "[", 
          RowBox[{"{", 
           RowBox[{"range", ",", "partition"}], "}"}], "]"}]}]}], "]"}]}]}], 
    "]"}]}], ";"}]], "Input",
 InitializationCell->True]
}, Closed]]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["4. Perturbations of curvature tensors",
 FontColor->RGBColor[0, 0, 1]]], "Subsection"],

Cell[CellGroupData[{

Cell["4.1. Perturbation of the metric tensor. Not used now", "Subsubsection"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefPertMetric", "[", 
    RowBox[{
     RowBox[{"metric_", "[", 
      RowBox[{
       RowBox[{"-", "a_"}], ",", 
       RowBox[{"-", "b_"}]}], "]"}], ",", "pert_"}], "]"}], ":=", 
   RowBox[{"(", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"Perturbation", "[", 
       RowBox[{
        RowBox[{"metric", "[", 
         RowBox[{
          RowBox[{"-", "a_Symbol"}], ",", 
          RowBox[{"-", "b_Symbol"}]}], "]"}], ",", "n_."}], "]"}], ":=", 
      RowBox[{"pert", "[", 
       RowBox[{
        RowBox[{"LI", "[", "n", "]"}], ",", 
        RowBox[{"-", "a"}], ",", 
        RowBox[{"-", "b"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Perturbation", "[", 
       RowBox[{
        RowBox[{"pert", "[", 
         RowBox[{
          RowBox[{"LI", "[", "n1_", "]"}], ",", 
          RowBox[{"-", "a_Symbol"}], ",", 
          RowBox[{"-", "b_Symbol"}]}], "]"}], ",", "n_."}], "]"}], ":=", 
      RowBox[{"pert", "[", 
       RowBox[{
        RowBox[{"LI", "[", 
         RowBox[{"n1", "+", "n"}], "]"}], ",", 
        RowBox[{"-", "a"}], ",", 
        RowBox[{"-", "b"}]}], "]"}]}]}], ")"}]}], ";"}]], "Input",
 Evaluatable->False]
}, Closed]],

Cell[CellGroupData[{

Cell["4.2. Perturbation of the inverse metric tensor", "Subsubsection"],

Cell[TextData[{
 "In order to construct the ",
 StyleBox["GeneralPerturbation",
  FontFamily->"Courier"],
 " term we need to define"
}], "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"productPert", "[", 
    RowBox[{
     RowBox[{"{", "p_", "}"}], ",", "vbundle_", ",", "pert_"}], "]"}], "[", 
   RowBox[{"a_", ",", "b_"}], "]"}], ":=", 
  RowBox[{"pert", "[", 
   RowBox[{
    RowBox[{"LI", "[", "p", "]"}], ",", "a", ",", "b"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"productPert", "[", 
    RowBox[{"partition_List", ",", "vbundle_", ",", "pert_"}], "]"}], "[", 
   RowBox[{"a_", ",", "b_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"m", "=", 
       RowBox[{"Length", "[", "partition", "]"}]}], ",", "i", ",", 
      "indices"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"indices", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"DummyIn", "[", "vbundle", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"m", "-", "1"}], "}"}]}], "]"}]}], ";", 
     RowBox[{
      RowBox[{"pert", "[", 
       RowBox[{
        RowBox[{"LI", "[", 
         RowBox[{"partition", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", "a", ",", 
        RowBox[{"indices", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], "]"}], 
      RowBox[{"Product", "[", 
       RowBox[{
        RowBox[{"pert", "[", 
         RowBox[{
          RowBox[{"LI", "[", 
           RowBox[{"partition", "[", 
            RowBox[{"[", 
             RowBox[{"i", "+", "1"}], "]"}], "]"}], "]"}], ",", 
          RowBox[{"ChangeIndex", "[", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "]"}], ",", 
          RowBox[{"indices", "[", 
           RowBox[{"[", 
            RowBox[{"i", "+", "1"}], "]"}], "]"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", 
          RowBox[{"m", "-", "2"}]}], "}"}]}], "]"}], 
      RowBox[{"pert", "[", 
       RowBox[{
        RowBox[{"LI", "[", 
         RowBox[{"partition", "[", 
          RowBox[{"[", "m", "]"}], "]"}], "]"}], ",", 
        RowBox[{"ChangeIndex", "[", 
         RowBox[{"indices", "[", 
          RowBox[{"[", 
           RowBox[{"m", "-", "1"}], "]"}], "]"}], "]"}], ",", "b"}], 
       "]"}]}]}]}], "]"}]}]}], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefGenPertInvMetric", "[", 
    RowBox[{"vbundle_", ",", 
     RowBox[{"metric_", "[", 
      RowBox[{"a_", ",", "b_"}], "]"}], ",", "pert_"}], "]"}], ":=", 
   RowBox[{"(", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"ExpandPerturbation1", "[", 
      RowBox[{
       RowBox[{"Perturbation", "[", 
        RowBox[{
         RowBox[{"metric", "[", 
          RowBox[{"a_Symbol", ",", "b_Symbol"}], "]"}], ",", "order_."}], 
        "]"}], ",", "options___"}], "]"}], ":=", 
     RowBox[{"Plus", "@@", 
      RowBox[{"(", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{"-", "1"}], ")"}], "^", 
            RowBox[{"Length", "[", "#", "]"}]}], 
           RowBox[{"(", 
            RowBox[{"Multinomial", "@@", "#"}], ")"}], 
           RowBox[{
            RowBox[{"productPert", "[", 
             RowBox[{"#", ",", "vbundle", ",", "pert"}], "]"}], "[", 
            RowBox[{"a", ",", "b"}], "]"}]}], "&"}], ",", 
         RowBox[{"SortedPartitions", "[", "order", "]"}]}], "]"}], ")"}]}]}], 
    ")"}]}], ";"}]], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["4.3. Perturbation of the determinant of the metric", "Subsubsection"],

Cell["Original code:", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefGenPertDet", "[", 
    RowBox[{"vbundle_", ",", "metric_", ",", "pert_"}], "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"dim", "=", 
        RowBox[{"DimOfVBundle", "[", "vbundle", "]"}]}], ",", 
       RowBox[{"metricepsilon", "=", 
        RowBox[{"epsilon", "[", "metric", "]"}]}], ",", 
       RowBox[{"mdet", "=", 
        RowBox[{
         RowBox[{"Determinant", "[", "metric", "]"}], "[", "]"}]}]}], "}"}], 
     ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"ExpandPerturbation1", "[", 
        RowBox[{"Perturbation", "[", 
         RowBox[{"mdet", ",", "order_."}], "]"}], "]"}], ":=", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"inds", "=", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"DummyIn", "[", "vbundle", "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", "dim"}], "}"}]}], "]"}]}], "}"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"With", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"inds1", "=", 
              RowBox[{"inds", "[", 
               RowBox[{"[", 
                RowBox[{"Range", "[", "dim", "]"}], "]"}], "]"}]}], ",", 
             RowBox[{"inds2", "=", 
              RowBox[{"inds", "[", 
               RowBox[{"[", 
                RowBox[{"Range", "[", 
                 RowBox[{
                  RowBox[{"dim", "+", "1"}], ",", 
                  RowBox[{"2", "dim"}]}], "]"}], "]"}], "]"}]}]}], "}"}], ",", 
           RowBox[{"ContractMetric", "[", 
            RowBox[{
             RowBox[{"mdet", "/", 
              RowBox[{"dim", "!"}]}], 
             RowBox[{"SignDetOfMetric", "[", "metric", "]"}], 
             RowBox[{"metricepsilon", "@@", "inds1"}], " ", 
             RowBox[{"metricepsilon", "@@", "inds2"}], " ", 
             RowBox[{"Perturbation", "[", 
              RowBox[{
               RowBox[{"Times", "@@", 
                RowBox[{"Apply", "[", 
                 RowBox[{"metric", ",", 
                  RowBox[{"Transpose", "[", 
                   RowBox[{"-", 
                    RowBox[{"{", 
                    RowBox[{"inds1", ",", "inds2"}], "}"}]}], "]"}], ",", 
                  RowBox[{"{", "1", "}"}]}], "]"}]}], ",", "order"}], "]"}]}],
             "]"}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ExpandPerturbation1", "[", 
        RowBox[{"Perturbation", "[", 
         RowBox[{
          RowBox[{"metricepsilon", "[", 
           RowBox[{"superinds__", "?", "UpIndexQ"}], "]"}], ",", "order_."}], 
         "]"}], "]"}], ":=", 
       RowBox[{
        RowBox[{"metricepsilon", "[", "superinds", "]"}], 
        RowBox[{"Sqrt", "[", "mdet", "]"}], 
        RowBox[{"ExpandPerturbation", "[", 
         RowBox[{"Perturbation", "[", 
          RowBox[{
           RowBox[{"1", "/", 
            RowBox[{"Sqrt", "[", "mdet", "]"}]}], ",", "order"}], "]"}], 
         "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ExpandPerturbation1", "[", 
        RowBox[{"Perturbation", "[", 
         RowBox[{
          RowBox[{"metricepsilon", "[", 
           RowBox[{"subinds__", "?", "DownIndexQ"}], "]"}], ",", "order_."}], 
         "]"}], "]"}], ":=", 
       RowBox[{
        RowBox[{
         RowBox[{"metricepsilon", "[", "subinds", "]"}], "/", 
         RowBox[{"Sqrt", "[", "mdet", "]"}]}], 
        RowBox[{"ExpandPerturbation", "[", 
         RowBox[{"Perturbation", "[", 
          RowBox[{
           RowBox[{"Sqrt", "[", "mdet", "]"}], ",", "order"}], "]"}], 
         "]"}]}]}], ";"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
    "]"}]}], ";"}]], "Input",
 Evaluatable->False],

Cell["\<\
New code, contributed by Cyril Pitrou. Perturbation from the Log-Trace \
formula. Should work in any dimension, even abstract dimensions, but it does \
not use the identities when the order of perturbation is higher than the \
dimension:\
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"productPertDet0", "[", 
     RowBox[{
      RowBox[{"{", "p_", "}"}], ",", "vbundle_", ",", "pert_"}], "]"}], ":=", 
    
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"ind", "=", 
        RowBox[{"DummyIn", "[", "vbundle", "]"}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"pert", "[", 
        RowBox[{
         RowBox[{"LI", "[", "p", "]"}], ",", 
         RowBox[{"-", "ind"}], ",", "ind"}], "]"}], "/", 
       RowBox[{"p", "!"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"productPertDet0", "[", 
     RowBox[{"partition_List", ",", "vbundle_", ",", "pert_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"m", "=", 
         RowBox[{"Length", "[", "partition", "]"}]}], ",", "i", ",", 
        "indices"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"indices", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"DummyIn", "[", "vbundle", "]"}], ",", 
          RowBox[{"{", "m", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"1", "/", 
         RowBox[{"Times", "@@", 
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"#", "!"}], "&"}], ",", "partition"}], "]"}]}]}], 
        "\[IndentingNewLine]", " ", 
        RowBox[{"pert", "[", 
         RowBox[{
          RowBox[{"LI", "[", 
           RowBox[{"partition", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", 
          RowBox[{"ChangeIndex", "[", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "m", "]"}], "]"}], "]"}], ",", 
          RowBox[{"indices", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], "]"}], 
        RowBox[{"Product", "[", 
         RowBox[{
          RowBox[{"pert", "[", 
           RowBox[{
            RowBox[{"LI", "[", 
             RowBox[{"partition", "[", 
              RowBox[{"[", 
               RowBox[{"i", "+", "1"}], "]"}], "]"}], "]"}], ",", 
            RowBox[{"ChangeIndex", "[", 
             RowBox[{"indices", "[", 
              RowBox[{"[", "i", "]"}], "]"}], "]"}], ",", 
            RowBox[{"indices", "[", 
             RowBox[{"[", 
              RowBox[{"i", "+", "1"}], "]"}], "]"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"m", "-", "1"}]}], "}"}]}], "]"}]}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"productPertDet1", "[", 
     RowBox[{
     "partitionK_List", ",", "partitionL_List", ",", "vbundle_", ",", 
      "pert_"}], "]"}], ":=", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"m", "=", 
        RowBox[{"Length", "[", "partitionK", "]"}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{"-", "1"}], ")"}], "^", "m"}], "/", 
         RowBox[{"m", "!"}]}], "/", 
        RowBox[{"Times", "@@", "partitionK"}]}], " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"m", "\[GreaterEqual]", "2"}], ",", 
         RowBox[{"Product", "[", 
          RowBox[{
           RowBox[{"productPertDet0", "[", 
            RowBox[{
             RowBox[{"Take", "[", 
              RowBox[{"partitionL", ",", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"1", "+", 
                  RowBox[{"Plus", "@@", 
                   RowBox[{"Take", "[", 
                    RowBox[{"partitionK", ",", 
                    RowBox[{"i", "-", "1"}]}], "]"}]}]}], ",", 
                 RowBox[{"Plus", "@@", 
                  RowBox[{"Take", "[", 
                   RowBox[{"partitionK", ",", "i"}], "]"}]}]}], "}"}]}], 
              "]"}], ",", "vbundle", ",", "pert"}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", "2", ",", "m"}], "}"}]}], "]"}], ",", 
         "\[IndentingNewLine]", "1"}], "]"}], "\[IndentingNewLine]", 
       RowBox[{"productPertDet0", "[", 
        RowBox[{
         RowBox[{"Take", "[", 
          RowBox[{"partitionL", ",", 
           RowBox[{"{", 
            RowBox[{"1", ",", 
             RowBox[{"partitionK", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "}"}]}], "]"}], ",", 
         "vbundle", ",", "pert"}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"productPertDet2", "[", 
    RowBox[{"partition_List", ",", "vbundle_", ",", "pert_"}], "]"}], ":=", 
   RowBox[{"Plus", "@@", 
    RowBox[{"Map", "[", " ", 
     RowBox[{
      RowBox[{
       RowBox[{"productPertDet1", "[", 
        RowBox[{"#", ",", "partition", ",", "vbundle", ",", "pert"}], "]"}], 
       "&"}], ",", 
      RowBox[{"SortedPartitions", "[", 
       RowBox[{"Length", "[", "partition", "]"}], "]"}]}], "]"}]}]}], 
  ";"}]}], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefGenPertDet", "[", 
    RowBox[{"vbundle_", ",", "metric_", ",", "pert_"}], "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"dim", "=", 
        RowBox[{"DimOfVBundle", "[", "vbundle", "]"}]}], ",", 
       RowBox[{"metricepsilon", "=", 
        RowBox[{"epsilon", "[", "metric", "]"}]}], ",", 
       RowBox[{"mdet", "=", 
        RowBox[{
         RowBox[{"Determinant", "[", "metric", "]"}], "[", "]"}]}]}], "}"}], 
     ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"ExpandPerturbation1", "[", 
        RowBox[{"Perturbation", "[", 
         RowBox[{"mdet", ",", "order_."}], "]"}], "]"}], ":=", 
       RowBox[{
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"inds", "=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"DummyIn", "[", "vbundle", "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", "dim"}], "}"}]}], "]"}]}], "}"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"inds1", "=", 
               RowBox[{"Take", "[", 
                RowBox[{"inds", ",", "dim"}], "]"}]}], ",", 
              RowBox[{"inds2", "=", 
               RowBox[{"Take", "[", 
                RowBox[{"inds", ",", 
                 RowBox[{"-", "dim"}]}], "]"}]}]}], "}"}], ",", 
            RowBox[{"ContractMetric", "[", 
             RowBox[{
              RowBox[{"mdet", "/", 
               RowBox[{"dim", "!"}]}], 
              RowBox[{"SignDetOfMetric", "[", "metric", "]"}], 
              RowBox[{"metricepsilon", "@@", "inds1"}], " ", 
              RowBox[{"metricepsilon", "@@", "inds2"}], " ", 
              RowBox[{"Perturbation", "[", 
               RowBox[{
                RowBox[{"Times", "@@", 
                 RowBox[{"Apply", "[", 
                  RowBox[{"metric", ",", 
                   RowBox[{"Transpose", "[", 
                    RowBox[{"-", 
                    RowBox[{"{", 
                    RowBox[{"inds1", ",", "inds2"}], "}"}]}], "]"}], ",", 
                   RowBox[{"{", "1", "}"}]}], "]"}]}], ",", "order"}], 
               "]"}]}], "]"}]}], "\[IndentingNewLine]", "]"}]}], 
         "\[IndentingNewLine]", "]"}], "/;", 
        RowBox[{
         RowBox[{"IntegerQ", "[", "dim", "]"}], "&&", 
         RowBox[{"order", ">", "dim"}]}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ExpandPerturbation1", "[", 
        RowBox[{"Perturbation", "[", 
         RowBox[{"mdet", ",", "order_."}], "]"}], "]"}], ":=", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"mdet", " ", 
         RowBox[{"order", "!"}], 
         RowBox[{"Plus", "@@", 
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"(", 
                RowBox[{"-", "1"}], ")"}], "^", 
               RowBox[{"Length", "[", "#", "]"}]}], 
              RowBox[{"productPertDet2", "[", 
               RowBox[{"#", ",", "vbundle", ",", "pert"}], "]"}]}], "&"}], 
            ",", 
            RowBox[{"SortedPartitions", "[", "order", "]"}]}], "]"}]}]}], "/;", 
        RowBox[{
         RowBox[{"!", 
          RowBox[{"IntegerQ", "[", "dim", "]"}]}], "||", 
         RowBox[{"order", "\[LessEqual]", "dim"}]}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ExpandPerturbation1", "[", 
        RowBox[{"Perturbation", "[", 
         RowBox[{
          RowBox[{"metricepsilon", "[", 
           RowBox[{"superinds__", "?", "UpIndexQ"}], "]"}], ",", "order_."}], 
         "]"}], "]"}], ":=", 
       RowBox[{
        RowBox[{"metricepsilon", "[", "superinds", "]"}], 
        RowBox[{"Sqrt", "[", "mdet", "]"}], 
        RowBox[{"ExpandPerturbation", "[", 
         RowBox[{"Perturbation", "[", 
          RowBox[{
           RowBox[{"1", "/", 
            RowBox[{"Sqrt", "[", "mdet", "]"}]}], ",", "order"}], "]"}], 
         "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ExpandPerturbation1", "[", 
        RowBox[{"Perturbation", "[", 
         RowBox[{
          RowBox[{"metricepsilon", "[", 
           RowBox[{"subinds__", "?", "DownIndexQ"}], "]"}], ",", "order_."}], 
         "]"}], "]"}], ":=", 
       RowBox[{
        RowBox[{
         RowBox[{"metricepsilon", "[", "subinds", "]"}], "/", 
         RowBox[{"Sqrt", "[", "mdet", "]"}]}], 
        RowBox[{"ExpandPerturbation", "[", 
         RowBox[{"Perturbation", "[", 
          RowBox[{
           RowBox[{"Sqrt", "[", "mdet", "]"}], ",", "order"}], "]"}], 
         "]"}]}]}], ";"}]}], "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["4.4. Perturbation of the Christoffel tensor", "Subsubsection"],

Cell["General term:", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"productThreePert", "[", 
    RowBox[{
     RowBox[{"{", "p_", "}"}], ",", "vbundle_", ",", "covd_", ",", "pert_"}], 
    "]"}], "[", 
   RowBox[{"a_", ",", "b_", ",", "c_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"ThreePert", "[", 
    RowBox[{"covd", ",", "pert"}], "]"}], "[", 
   RowBox[{
    RowBox[{"LI", "[", "p", "]"}], ",", "a", ",", "b", ",", "c"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"productThreePert", "[", 
    RowBox[{"partition_List", ",", "vbundle_", ",", "covd_", ",", "pert_"}], 
    "]"}], "[", 
   RowBox[{"a_", ",", "b_", ",", "c_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"m", "=", 
       RowBox[{"Length", "[", "partition", "]"}]}], ",", "i", ",", 
      "indices"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"indices", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"DummyIn", "[", "vbundle", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"m", "-", "1"}], "}"}]}], "]"}]}], ";", 
     RowBox[{
      RowBox[{"pert", "[", 
       RowBox[{
        RowBox[{"LI", "[", 
         RowBox[{"partition", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", "a", ",", 
        RowBox[{"indices", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], "]"}], 
      RowBox[{"Product", "[", 
       RowBox[{
        RowBox[{"pert", "[", 
         RowBox[{
          RowBox[{"LI", "[", 
           RowBox[{"partition", "[", 
            RowBox[{"[", 
             RowBox[{"i", "+", "1"}], "]"}], "]"}], "]"}], ",", 
          RowBox[{"ChangeIndex", "[", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "]"}], ",", 
          RowBox[{"indices", "[", 
           RowBox[{"[", 
            RowBox[{"i", "+", "1"}], "]"}], "]"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", 
          RowBox[{"m", "-", "2"}]}], "}"}]}], "]"}], 
      RowBox[{
       RowBox[{"ThreePert", "[", 
        RowBox[{"covd", ",", "pert"}], "]"}], "[", 
       RowBox[{
        RowBox[{"LI", "[", 
         RowBox[{"partition", "[", 
          RowBox[{"[", "m", "]"}], "]"}], "]"}], ",", 
        RowBox[{"ChangeIndex", "[", 
         RowBox[{"indices", "[", 
          RowBox[{"[", 
           RowBox[{"m", "-", "1"}], "]"}], "]"}], "]"}], ",", "b", ",", "c"}],
        "]"}]}]}]}], "]"}]}]}], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefGenPertChristoffel", "[", 
    RowBox[{"vbundle_", ",", "covd_", ",", "pert_", ",", 
     RowBox[{"christoffel_", "[", 
      RowBox[{"a_", ",", 
       RowBox[{"-", "b_"}], ",", 
       RowBox[{"-", "c_"}]}], "]"}]}], "]"}], ":=", 
   RowBox[{"(", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"ExpandPerturbation1", "[", 
      RowBox[{"Perturbation", "[", 
       RowBox[{
        RowBox[{"christoffel", "[", 
         RowBox[{"a_Symbol", ",", 
          RowBox[{"-", "b_Symbol"}], ",", 
          RowBox[{"-", "c_Symbol"}]}], "]"}], ",", "order_."}], "]"}], "]"}], 
     ":=", 
     RowBox[{"Plus", "@@", 
      RowBox[{"(", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"-", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"-", "1"}], ")"}], "^", 
             RowBox[{"Length", "[", "#", "]"}]}]}], 
           RowBox[{"(", 
            RowBox[{"Multinomial", "@@", "#"}], ")"}], 
           RowBox[{
            RowBox[{"productThreePert", "[", 
             RowBox[{"#", ",", "vbundle", ",", "covd", ",", "pert"}], "]"}], 
            "[", 
            RowBox[{"a", ",", 
             RowBox[{"-", "b"}], ",", 
             RowBox[{"-", "c"}]}], "]"}]}], "&"}], ",", 
         RowBox[{"SortedPartitions", "[", "order", "]"}]}], "]"}], ")"}]}]}], 
    ")"}]}], ";"}]], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["4.5. Perturbation of the Riemann tensor", "Subsubsection"],

Cell["\<\
General term. There is first the expression in terms of the perturbations of \
the Christoffel tensor. We give it here, but do not include it in the package:\
\>", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefGenPertRiemannFromChristoffel", "[", 
    RowBox[{"vbundle_", ",", "covd_", ",", "christoffel_", ",", 
     RowBox[{"riemann_", "[", 
      RowBox[{
       RowBox[{"-", "a_"}], ",", 
       RowBox[{"-", "b_"}], ",", 
       RowBox[{"-", "c_"}], ",", "d_"}], "]"}]}], "]"}], ":=", 
   RowBox[{"(", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"GeneralPerturbation0", "[", 
      RowBox[{
       RowBox[{"riemann", "[", 
        RowBox[{
         RowBox[{"-", "a_Symbol"}], ",", 
         RowBox[{"-", "b_Symbol"}], ",", 
         RowBox[{"-", "c_Symbol"}], ",", "d_Symbol"}], "]"}], ",", 
       "order_Integer"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"dummy", "=", 
         RowBox[{"DummyIn", "[", "vbundle", "]"}]}], "}"}], ",", 
       RowBox[{"2", 
        RowBox[{"Antisymmetrize", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"covd", "[", 
             RowBox[{"-", "b"}], "]"}], "[", 
            RowBox[{"Perturbation", "[", 
             RowBox[{
              RowBox[{"christoffel", "[", 
               RowBox[{"d", ",", 
                RowBox[{"-", "a"}], ",", 
                RowBox[{"-", "c"}]}], "]"}], ",", "order"}], "]"}], "]"}], 
           "-", 
           RowBox[{"Sum", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Binomial", "[", 
               RowBox[{"order", ",", "k"}], "]"}], 
              RowBox[{"Perturbation", "[", 
               RowBox[{
                RowBox[{"christoffel", "[", 
                 RowBox[{"d", ",", 
                  RowBox[{"-", "dummy"}], ",", 
                  RowBox[{"-", "a"}]}], "]"}], ",", "k"}], "]"}], 
              RowBox[{"Perturbation", "[", 
               RowBox[{
                RowBox[{"christoffel", "[", 
                 RowBox[{"dummy", ",", 
                  RowBox[{"-", "b"}], ",", 
                  RowBox[{"-", "c"}]}], "]"}], ",", 
                RowBox[{"order", "-", "k"}]}], "]"}]}], ",", 
             RowBox[{"{", 
              RowBox[{"k", ",", "1", ",", 
               RowBox[{"order", "-", "1"}]}], "}"}]}], "]"}]}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"-", "a"}], ",", 
            RowBox[{"-", "b"}]}], "}"}]}], "]"}]}]}], "]"}]}], ")"}]}], 
  ";"}]], "Input"],

Cell["\<\
Then we have an expression given directly in terms of the derivatives of the \
metric:\
\>", "Text"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"productRiemann1", "[", 
    RowBox[{
     RowBox[{"{", "p_", "}"}], ",", "vbundle_", ",", "covd_", ",", "pert_"}], 
    "]"}], "[", 
   RowBox[{"a_", ",", "b_", ",", "c_", ",", "d_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"covd", "[", "a", "]"}], "[", 
   RowBox[{
    RowBox[{"ThreePert", "[", 
     RowBox[{"covd", ",", "pert"}], "]"}], "[", 
    RowBox[{
     RowBox[{"LI", "[", "p", "]"}], ",", "d", ",", "c", ",", "b"}], "]"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"productRiemann1", "[", 
    RowBox[{"partition_List", ",", "vbundle_", ",", "covd_", ",", "pert_"}], 
    "]"}], "[", 
   RowBox[{"a_", ",", "b_", ",", "c_", ",", "d_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"m", "=", 
       RowBox[{"Length", "[", "partition", "]"}]}], ",", "i", ",", 
      "indices"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"indices", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"DummyIn", "[", "vbundle", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"m", "-", "1"}], "}"}]}], "]"}]}], ";", 
     RowBox[{
      RowBox[{"pert", "[", 
       RowBox[{
        RowBox[{"LI", "[", 
         RowBox[{"partition", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", "d", ",", 
        RowBox[{"indices", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], "]"}], 
      RowBox[{"Product", "[", 
       RowBox[{
        RowBox[{"pert", "[", 
         RowBox[{
          RowBox[{"LI", "[", 
           RowBox[{"partition", "[", 
            RowBox[{"[", 
             RowBox[{"i", "+", "1"}], "]"}], "]"}], "]"}], ",", 
          RowBox[{"ChangeIndex", "[", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "]"}], ",", 
          RowBox[{"indices", "[", 
           RowBox[{"[", 
            RowBox[{"i", "+", "1"}], "]"}], "]"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", 
          RowBox[{"m", "-", "2"}]}], "}"}]}], "]"}], 
      RowBox[{
       RowBox[{"covd", "[", "a", "]"}], "[", 
       RowBox[{
        RowBox[{"ThreePert", "[", 
         RowBox[{"covd", ",", "pert"}], "]"}], "[", 
        RowBox[{
         RowBox[{"LI", "[", 
          RowBox[{"partition", "[", 
           RowBox[{"[", "m", "]"}], "]"}], "]"}], ",", 
         RowBox[{"ChangeIndex", "[", 
          RowBox[{"indices", "[", 
           RowBox[{"[", 
            RowBox[{"m", "-", "1"}], "]"}], "]"}], "]"}], ",", "c", ",", 
         "b"}], "]"}], "]"}]}]}]}], "]"}]}]}], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"productRiemann2", "[", 
    RowBox[{
    "partition_List", ",", "s_", ",", "vbundle_", ",", "covd_", ",", 
     "pert_"}], "]"}], "[", 
   RowBox[{"a_", ",", "b_", ",", "c_", ",", "d_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"m", "=", 
        RowBox[{"Length", "[", "partition", "]"}]}], ",", "i", ",", 
       "indices"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"indices", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"DummyIn", "[", "vbundle", "]"}], ",", 
         RowBox[{"{", "s", "}"}]}], "]"}]}], ";", 
      RowBox[{
       RowBox[{
        RowBox[{"ThreePert", "[", 
         RowBox[{"covd", ",", "pert"}], "]"}], "[", 
        RowBox[{
         RowBox[{"LI", "[", 
          RowBox[{"partition", "[", 
           RowBox[{"[", "s", "]"}], "]"}], "]"}], ",", 
         RowBox[{"indices", "[", 
          RowBox[{"[", "s", "]"}], "]"}], ",", "d", ",", "a"}], "]"}], 
       RowBox[{"Product", "[", 
        RowBox[{
         RowBox[{"pert", "[", 
          RowBox[{
           RowBox[{"LI", "[", 
            RowBox[{"partition", "[", 
             RowBox[{"[", "i", "]"}], "]"}], "]"}], ",", 
           RowBox[{"ChangeIndex", "[", 
            RowBox[{"indices", "[", 
             RowBox[{"[", 
              RowBox[{"i", "+", "1"}], "]"}], "]"}], "]"}], ",", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"s", "-", "1"}], ",", "2", ",", 
           RowBox[{"-", "1"}]}], "}"}]}], "]"}], 
       RowBox[{
        RowBox[{"ThreePert", "[", 
         RowBox[{"covd", ",", "pert"}], "]"}], "[", 
        RowBox[{
         RowBox[{"LI", "[", 
          RowBox[{"partition", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", 
         RowBox[{"ChangeIndex", "[", 
          RowBox[{"indices", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "]"}], ",", "b", ",", "c"}], 
        "]"}]}]}]}], "]"}], "/;", 
   RowBox[{"s", "\[Equal]", 
    RowBox[{"Length", "[", "partition", "]"}]}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"productRiemann2", "[", 
    RowBox[{
    "partition_List", ",", "s_", ",", "vbundle_", ",", "covd_", ",", 
     "pert_"}], "]"}], "[", 
   RowBox[{"a_", ",", "b_", ",", "c_", ",", "d_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"m", "=", 
        RowBox[{"Length", "[", "partition", "]"}]}], ",", "i", ",", 
       "indices"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"indices", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"DummyIn", "[", "vbundle", "]"}], ",", 
         RowBox[{"{", "m", "}"}]}], "]"}]}], ";", 
      RowBox[{
       RowBox[{"pert", "[", 
        RowBox[{
         RowBox[{"LI", "[", 
          RowBox[{"partition", "[", 
           RowBox[{"[", "m", "]"}], "]"}], "]"}], ",", "d", ",", 
         RowBox[{"indices", "[", 
          RowBox[{"[", "m", "]"}], "]"}]}], "]"}], 
       RowBox[{"Product", "[", 
        RowBox[{
         RowBox[{"pert", "[", 
          RowBox[{
           RowBox[{"LI", "[", 
            RowBox[{"partition", "[", 
             RowBox[{"[", "i", "]"}], "]"}], "]"}], ",", 
           RowBox[{"ChangeIndex", "[", 
            RowBox[{"indices", "[", 
             RowBox[{"[", 
              RowBox[{"i", "+", "1"}], "]"}], "]"}], "]"}], ",", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"m", "-", "1"}], ",", 
           RowBox[{"s", "+", "1"}], ",", 
           RowBox[{"-", "1"}]}], "}"}]}], "]"}], 
       RowBox[{
        RowBox[{"ThreePert", "[", 
         RowBox[{"covd", ",", "pert"}], "]"}], "[", 
        RowBox[{
         RowBox[{"LI", "[", 
          RowBox[{"partition", "[", 
           RowBox[{"[", "s", "]"}], "]"}], "]"}], ",", 
         RowBox[{"indices", "[", 
          RowBox[{"[", "s", "]"}], "]"}], ",", 
         RowBox[{"ChangeIndex", "[", 
          RowBox[{"indices", "[", 
           RowBox[{"[", 
            RowBox[{"s", "+", "1"}], "]"}], "]"}], "]"}], ",", "a"}], "]"}], 
       RowBox[{"Product", "[", 
        RowBox[{
         RowBox[{"pert", "[", 
          RowBox[{
           RowBox[{"LI", "[", 
            RowBox[{"partition", "[", 
             RowBox[{"[", "i", "]"}], "]"}], "]"}], ",", 
           RowBox[{"ChangeIndex", "[", 
            RowBox[{"indices", "[", 
             RowBox[{"[", 
              RowBox[{"i", "+", "1"}], "]"}], "]"}], "]"}], ",", 
           RowBox[{"indices", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", 
           RowBox[{"s", "-", "1"}], ",", "2", ",", 
           RowBox[{"-", "1"}]}], "}"}]}], "]"}], 
       RowBox[{
        RowBox[{"ThreePert", "[", 
         RowBox[{"covd", ",", "pert"}], "]"}], "[", 
        RowBox[{
         RowBox[{"LI", "[", 
          RowBox[{"partition", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", 
         RowBox[{"ChangeIndex", "[", 
          RowBox[{"indices", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "]"}], ",", "b", ",", "c"}], 
        "]"}]}]}]}], "]"}], "/;", 
   RowBox[{"2", "\[LessEqual]", "s", "<", 
    RowBox[{"Length", "[", "partition", "]"}]}]}]}]}], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"genpertriemann", "[", 
    RowBox[{"vbundle_", ",", "covd_", ",", "pert_", ",", 
     RowBox[{"IndexList", "[", 
      RowBox[{
       RowBox[{"-", "a_"}], ",", 
       RowBox[{"-", "b_"}], ",", 
       RowBox[{"-", "c_"}], ",", "d_"}], "]"}], ",", "order_"}], "]"}], ":=", 
   
   RowBox[{"2", 
    RowBox[{"Antisymmetrize", "[", 
     RowBox[{
      RowBox[{"Plus", "@@", 
       RowBox[{"(", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{"-", "1"}], ")"}], "^", 
             RowBox[{"Length", "[", "#", "]"}]}], 
            RowBox[{"(", 
             RowBox[{"Multinomial", "@@", "#"}], ")"}], 
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"productRiemann1", "[", 
                RowBox[{"#", ",", "vbundle", ",", "covd", ",", "pert"}], 
                "]"}], "[", 
               RowBox[{
                RowBox[{"-", "a"}], ",", 
                RowBox[{"-", "b"}], ",", 
                RowBox[{"-", "c"}], ",", "d"}], "]"}], "+", 
              RowBox[{"Sum", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"productRiemann2", "[", 
                  RowBox[{
                  "#", ",", "s", ",", "vbundle", ",", "covd", ",", "pert"}], 
                  "]"}], "[", 
                 RowBox[{
                  RowBox[{"-", "a"}], ",", 
                  RowBox[{"-", "b"}], ",", 
                  RowBox[{"-", "c"}], ",", "d"}], "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"s", ",", "2", ",", 
                  RowBox[{"Length", "[", "#", "]"}]}], "}"}]}], "]"}]}], 
             ")"}]}], "&"}], ",", 
          RowBox[{"SortedPartitions", "[", "order", "]"}]}], "]"}], ")"}]}], 
      ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", "a"}], ",", 
        RowBox[{"-", "b"}]}], "}"}]}], "]"}]}]}], ";"}]], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefGenPertRiemann", "[", 
    RowBox[{"vbundle_", ",", "covd_", ",", "pert_", ",", 
     RowBox[{"riemann_", "[", 
      RowBox[{
       RowBox[{"-", "a_"}], ",", 
       RowBox[{"-", "b_"}], ",", 
       RowBox[{"-", "c_"}], ",", "d_"}], "]"}]}], "]"}], ":=", 
   RowBox[{"(", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"ExpandPerturbation1", "[", 
       RowBox[{"Perturbation", "[", 
        RowBox[{
         RowBox[{"riemann", "[", 
          RowBox[{
           RowBox[{"-", "a_Symbol"}], ",", 
           RowBox[{"-", "b_Symbol"}], ",", 
           RowBox[{"-", "c_Symbol"}], ",", "d_Symbol"}], "]"}], ",", 
         "order_."}], "]"}], "]"}], ":=", 
      RowBox[{"genpertriemann", "[", 
       RowBox[{"vbundle", ",", "covd", ",", "pert", ",", 
        RowBox[{"IndexList", "[", 
         RowBox[{
          RowBox[{"-", "a"}], ",", 
          RowBox[{"-", "b"}], ",", 
          RowBox[{"-", "c"}], ",", "d"}], "]"}], ",", "order"}], "]"}]}], ";", 
     RowBox[{
      RowBox[{"ExpandPerturbation1", "[", 
       RowBox[{"Perturbation", "[", 
        RowBox[{
         RowBox[{"riemann", "[", 
          RowBox[{
           RowBox[{"-", "a_Symbol"}], ",", 
           RowBox[{"-", "b_Symbol"}], ",", 
           RowBox[{"-", "c_Symbol"}], ",", 
           RowBox[{"-", "d_Symbol"}]}], "]"}], ",", "order_."}], "]"}], "]"}],
       ":=", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"dummy", "=", 
           RowBox[{"DummyAs", "[", "c", "]"}]}], ",", 
          RowBox[{"metric", "=", 
           RowBox[{"xAct`xTensor`Private`FirstMetricOfVBundle", "[", 
            RowBox[{
             RowBox[{"VBundleOfIndex", "[", "d", "]"}], ",", "True"}], 
            "]"}]}]}], "}"}], ",", 
        RowBox[{"ExpandPerturbation", "@", 
         RowBox[{"Perturbation", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"riemann", "[", 
             RowBox[{
              RowBox[{"-", "a"}], ",", 
              RowBox[{"-", "b"}], ",", 
              RowBox[{"-", "c"}], ",", "dummy"}], "]"}], 
            RowBox[{"metric", "[", 
             RowBox[{
              RowBox[{"-", "dummy"}], ",", 
              RowBox[{"-", "d"}]}], "]"}]}], ",", "order"}], "]"}]}]}], 
       "]"}]}]}], ")"}]}], ";"}]], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["4.6. Perturbation of the Ricci tensor", "Subsubsection"],

Cell["\<\
We can get the GeneralPerturbation term directly from that of the Riemann \
tensor:\
\>", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefGenPertRicci", "[", 
    RowBox[{"vbundle_", ",", "covd_", ",", "pert_", ",", "riemann_", ",", 
     RowBox[{"ricci_", "[", 
      RowBox[{
       RowBox[{"-", "a_"}], ",", 
       RowBox[{"-", "b_"}]}], "]"}]}], "]"}], ":=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"ExpandPerturbation1", "[", 
      RowBox[{"Perturbation", "[", 
       RowBox[{
        RowBox[{"ricci", "[", 
         RowBox[{
          RowBox[{"-", "a_Symbol"}], ",", 
          RowBox[{"-", "b_Symbol"}]}], "]"}], ",", "order_."}], "]"}], "]"}], 
     ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"dummy", "=", 
         RowBox[{"DummyIn", "[", "vbundle", "]"}]}], "}"}], ",", 
       RowBox[{"genpertriemann", "[", 
        RowBox[{"vbundle", ",", "covd", ",", "pert", ",", 
         RowBox[{"IndexList", "[", 
          RowBox[{
           RowBox[{"-", "a"}], ",", 
           RowBox[{"-", "dummy"}], ",", 
           RowBox[{"-", "b"}], ",", "dummy"}], "]"}], ",", "order"}], "]"}]}],
       "]"}]}], ")"}]}], ";"}]], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["4.7. Perturbation of the RicciScalar", "Subsubsection"],

Cell["\<\
The perturbation of the RicciScalar is constructed from that of Ricci and the \
inverse metric:\
\>", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefGenPertRicciScalar", "[", 
    RowBox[{"vbundle_", ",", "metric_", ",", "ricci_", ",", "ricciscalar_"}], 
    "]"}], ":=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"ExpandPerturbation1", "[", 
      RowBox[{"Perturbation", "[", 
       RowBox[{
        RowBox[{"ricciscalar", "[", "]"}], ",", "order_."}], "]"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"dummy1", "=", 
          RowBox[{"DummyIn", "[", "vbundle", "]"}]}], ",", 
         RowBox[{"dummy2", "=", 
          RowBox[{"DummyIn", "[", "vbundle", "]"}]}]}], "}"}], ",", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Binomial", "[", 
           RowBox[{"order", ",", "k"}], "]"}], 
          RowBox[{"ExpandPerturbation1", "@", 
           RowBox[{"Perturbation", "[", 
            RowBox[{
             RowBox[{"ricci", "[", 
              RowBox[{
               RowBox[{"-", "dummy1"}], ",", 
               RowBox[{"-", "dummy2"}]}], "]"}], ",", "k"}], "]"}]}], 
          RowBox[{"ExpandPerturbation1", "@", 
           RowBox[{"Perturbation", "[", 
            RowBox[{
             RowBox[{"metric", "[", 
              RowBox[{"dummy1", ",", "dummy2"}], "]"}], ",", 
             RowBox[{"order", "-", "k"}]}], "]"}]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"k", ",", "0", ",", "order"}], "}"}]}], "]"}]}], "]"}]}], 
    ")"}]}], ";"}]], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["4.8. Perturbation of the Einstein tensor", "Subsubsection"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefGenPertEinstein", "[", 
    RowBox[{
    "vbundle_", ",", "metric_", ",", "ricci_", ",", "ricciscalar_", ",", 
     RowBox[{"einstein_", "[", 
      RowBox[{
       RowBox[{"-", "a_"}], ",", 
       RowBox[{"-", "b_"}]}], "]"}]}], "]"}], ":=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"ExpandPerturbation1", "[", 
      RowBox[{"Perturbation", "[", 
       RowBox[{
        RowBox[{"einstein", "[", 
         RowBox[{
          RowBox[{"-", "a_Symbol"}], ",", 
          RowBox[{"-", "b_Symbol"}]}], "]"}], ",", "order_."}], "]"}], "]"}], 
     ":=", 
     RowBox[{
      RowBox[{"ExpandPerturbation1", "@", 
       RowBox[{"Perturbation", "[", 
        RowBox[{
         RowBox[{"ricci", "[", 
          RowBox[{
           RowBox[{"-", "a"}], ",", 
           RowBox[{"-", "b"}]}], "]"}], ",", "order"}], "]"}]}], "-", 
      RowBox[{
       RowBox[{"1", "/", "2"}], 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Binomial", "[", 
           RowBox[{"order", ",", "k"}], "]"}], 
          RowBox[{"ExpandPerturbation1", "@", 
           RowBox[{"Perturbation", "[", 
            RowBox[{
             RowBox[{"metric", "[", 
              RowBox[{
               RowBox[{"-", "a"}], ",", 
               RowBox[{"-", "b"}]}], "]"}], ",", "k"}], "]"}]}], 
          RowBox[{"ExpandPerturbation1", "@", 
           RowBox[{"Perturbation", "[", 
            RowBox[{
             RowBox[{"ricciscalar", "[", "]"}], ",", 
             RowBox[{"order", "-", "k"}]}], "]"}]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"k", ",", "0", ",", "order"}], "}"}]}], "]"}]}]}]}], 
    ")"}]}], ";"}]], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["4.9. Perturbations of the Weyl tensor", "Subsubsection"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefGenPertWeyl", "[", 
    RowBox[{"weyl_", "[", 
     RowBox[{
      RowBox[{"-", "a_"}], ",", 
      RowBox[{"-", "b_"}], ",", 
      RowBox[{"-", "c_"}], ",", 
      RowBox[{"-", "d_"}]}], "]"}], "]"}], ":=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"ExpandPerturbation1", "[", 
      RowBox[{"Perturbation", "[", 
       RowBox[{
        RowBox[{"weyl", "[", 
         RowBox[{
          RowBox[{"-", "a_Symbol"}], ",", 
          RowBox[{"-", "b_Symbol"}], ",", 
          RowBox[{"-", "c_Symbol"}], ",", 
          RowBox[{"-", "d_Symbol"}]}], "]"}], ",", "order_."}], "]"}], "]"}], 
     ":=", 
     RowBox[{"ExpandPerturbation", "[", 
      RowBox[{"Perturbation", "[", 
       RowBox[{
        RowBox[{"WeylToRiemann", "[", 
         RowBox[{"weyl", "[", 
          RowBox[{
           RowBox[{"-", "a"}], ",", 
           RowBox[{"-", "b"}], ",", 
           RowBox[{"-", "c"}], ",", 
           RowBox[{"-", "d"}]}], "]"}], "]"}], ",", "order"}], "]"}], "]"}]}],
     ")"}]}], ";"}]], "Input",
 InitializationCell->True],

Cell["\<\
An expanded version of this formula was contributed by Cyril Pitrou (IAP, \
Paris) in Dec 2006:\
\>", "Text"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DefGenPertWeyl", "[", 
    RowBox[{
    "vbundle_", ",", "dimension_", ",", "metric_", ",", "ricci_", ",", 
     "ricciscalar_", ",", "riemann_", ",", 
     RowBox[{"weyl_", "[", 
      RowBox[{
       RowBox[{"-", "a_"}], ",", 
       RowBox[{"-", "b_"}], ",", 
       RowBox[{"-", "c_"}], ",", 
       RowBox[{"-", "d_"}]}], "]"}]}], "]"}], ":=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"ExpandPerturbation1", "[", 
      RowBox[{"Perturbation", "[", 
       RowBox[{
        RowBox[{"weyl", "[", 
         RowBox[{
          RowBox[{"-", "a_Symbol"}], ",", 
          RowBox[{"-", "b_Symbol"}], ",", 
          RowBox[{"-", "c_Symbol"}], ",", 
          RowBox[{"-", "d_Symbol"}]}], "]"}], ",", "order_."}], "]"}], "]"}], 
     ":=", " ", "\[IndentingNewLine]", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"dummy", "=", 
         RowBox[{"DummyIn", "[", "vbundle", "]"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Sum", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Binomial", "[", 
            RowBox[{"order", ",", "k"}], "]"}], 
           RowBox[{"ExpandPerturbation1", "@", 
            RowBox[{"Perturbation", "[", 
             RowBox[{
              RowBox[{"metric", "[", 
               RowBox[{
                RowBox[{"-", "d"}], ",", 
                RowBox[{"-", "dummy"}]}], "]"}], ",", "k"}], "]"}]}], 
           RowBox[{"ExpandPerturbation1", "@", 
            RowBox[{"Perturbation", "[", 
             RowBox[{
              RowBox[{"riemann", "[", 
               RowBox[{
                RowBox[{"-", "a"}], ",", 
                RowBox[{"-", "b"}], ",", 
                RowBox[{"-", "c"}], ",", "dummy"}], "]"}], ",", 
              RowBox[{"order", "-", "k"}]}], "]"}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"k", ",", "0", ",", "order"}], "}"}]}], "]"}], 
        "\[IndentingNewLine]", "-", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Sum", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Binomial", "[", 
               RowBox[{"order", ",", "k"}], "]"}], 
              RowBox[{"ExpandPerturbation1", "@", 
               RowBox[{"Perturbation", "[", 
                RowBox[{
                 RowBox[{"metric", "[", 
                  RowBox[{
                   RowBox[{"-", "a"}], ",", 
                   RowBox[{"-", "c"}]}], "]"}], ",", "k"}], "]"}]}], 
              RowBox[{"ExpandPerturbation1", "@", 
               RowBox[{"Perturbation", "[", 
                RowBox[{
                 RowBox[{"ricci", "[", 
                  RowBox[{
                   RowBox[{"-", "b"}], ",", 
                   RowBox[{"-", "d"}]}], "]"}], ",", 
                 RowBox[{"order", "-", "k"}]}], "]"}]}]}], ",", 
             RowBox[{"{", 
              RowBox[{"k", ",", "0", ",", "order"}], "}"}]}], "]"}], 
           "\[IndentingNewLine]", "+", 
           RowBox[{"Sum", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Binomial", "[", 
               RowBox[{"order", ",", "k"}], "]"}], 
              RowBox[{"ExpandPerturbation1", "@", 
               RowBox[{"Perturbation", "[", 
                RowBox[{
                 RowBox[{"metric", "[", 
                  RowBox[{
                   RowBox[{"-", "b"}], ",", 
                   RowBox[{"-", "d"}]}], "]"}], ",", "k"}], "]"}]}], 
              RowBox[{"ExpandPerturbation1", "@", 
               RowBox[{"Perturbation", "[", 
                RowBox[{
                 RowBox[{"ricci", "[", 
                  RowBox[{
                   RowBox[{"-", "a"}], ",", 
                   RowBox[{"-", "c"}]}], "]"}], ",", 
                 RowBox[{"order", "-", "k"}]}], "]"}]}]}], ",", 
             RowBox[{"{", 
              RowBox[{"k", ",", "0", ",", "order"}], "}"}]}], "]"}], 
           "\[IndentingNewLine]", "-", 
           RowBox[{"Sum", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Binomial", "[", 
               RowBox[{"order", ",", "k"}], "]"}], 
              RowBox[{"ExpandPerturbation1", "@", 
               RowBox[{"Perturbation", "[", 
                RowBox[{
                 RowBox[{"metric", "[", 
                  RowBox[{
                   RowBox[{"-", "a"}], ",", 
                   RowBox[{"-", "d"}]}], "]"}], ",", "k"}], "]"}]}], 
              RowBox[{"ExpandPerturbation1", "@", 
               RowBox[{"Perturbation", "[", 
                RowBox[{
                 RowBox[{"ricci", "[", 
                  RowBox[{
                   RowBox[{"-", "b"}], ",", 
                   RowBox[{"-", "c"}]}], "]"}], ",", 
                 RowBox[{"order", "-", "k"}]}], "]"}]}]}], ",", 
             RowBox[{"{", 
              RowBox[{"k", ",", "0", ",", "order"}], "}"}]}], "]"}], 
           "\[IndentingNewLine]", "-", 
           RowBox[{"Sum", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Binomial", "[", 
               RowBox[{"order", ",", "k"}], "]"}], 
              RowBox[{"ExpandPerturbation1", "@", 
               RowBox[{"Perturbation", "[", 
                RowBox[{
                 RowBox[{"metric", "[", 
                  RowBox[{
                   RowBox[{"-", "b"}], ",", 
                   RowBox[{"-", "c"}]}], "]"}], ",", "k"}], "]"}]}], 
              RowBox[{"ExpandPerturbation1", "@", 
               RowBox[{"Perturbation", "[", 
                RowBox[{
                 RowBox[{"ricci", "[", 
                  RowBox[{
                   RowBox[{"-", "a"}], ",", 
                   RowBox[{"-", "d"}]}], "]"}], ",", 
                 RowBox[{"order", "-", "k"}]}], "]"}]}]}], ",", 
             RowBox[{"{", 
              RowBox[{"k", ",", "0", ",", "order"}], "}"}]}], "]"}]}], ")"}], 
         "/", 
         RowBox[{"(", 
          RowBox[{"dimension", "-", "2"}], ")"}]}], "\[IndentingNewLine]", 
        "+", 
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Sum", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Binomial", "[", 
                RowBox[{"order", ",", "k"}], "]"}], 
               RowBox[{"ExpandPerturbation1", "@", 
                RowBox[{"Perturbation", "[", 
                 RowBox[{
                  RowBox[{"ricciscalar", "[", "]"}], ",", "k"}], "]"}]}], 
               RowBox[{"(", 
                RowBox[{"Sum", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Binomial", "[", 
                    RowBox[{
                    RowBox[{"order", "-", "k"}], ",", "m"}], "]"}], 
                   RowBox[{"ExpandPerturbation1", "@", 
                    RowBox[{"Perturbation", "[", 
                    RowBox[{
                    RowBox[{"metric", "[", 
                    RowBox[{
                    RowBox[{"-", "a"}], ",", 
                    RowBox[{"-", "c"}]}], "]"}], ",", "m"}], "]"}]}], 
                   RowBox[{"ExpandPerturbation1", "@", 
                    RowBox[{"Perturbation", "[", 
                    RowBox[{
                    RowBox[{"metric", "[", 
                    RowBox[{
                    RowBox[{"-", "b"}], ",", 
                    RowBox[{"-", "d"}]}], "]"}], ",", 
                    RowBox[{"order", "-", "k", "-", "m"}]}], "]"}]}]}], ",", 
                  RowBox[{"{", 
                   RowBox[{"m", ",", "0", ",", 
                    RowBox[{"order", "-", "k"}]}], "}"}]}], "]"}], ")"}]}], 
              ",", 
              RowBox[{"{", 
               RowBox[{"k", ",", "0", ",", "order"}], "}"}]}], "]"}], 
            "\[IndentingNewLine]", "-", 
            RowBox[{"(", 
             RowBox[{"Sum", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Binomial", "[", 
                 RowBox[{"order", ",", "k"}], "]"}], 
                RowBox[{"ExpandPerturbation1", "@", 
                 RowBox[{"Perturbation", "[", 
                  RowBox[{
                   RowBox[{"ricciscalar", "[", "]"}], ",", "k"}], "]"}]}], 
                RowBox[{"(", 
                 RowBox[{"Sum", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"Binomial", "[", 
                    RowBox[{
                    RowBox[{"order", "-", "k"}], ",", "m"}], "]"}], 
                    RowBox[{"ExpandPerturbation1", "@", 
                    RowBox[{"Perturbation", "[", 
                    RowBox[{
                    RowBox[{"metric", "[", 
                    RowBox[{
                    RowBox[{"-", "a"}], ",", 
                    RowBox[{"-", "d"}]}], "]"}], ",", "m"}], "]"}]}], 
                    RowBox[{"ExpandPerturbation1", "@", 
                    RowBox[{"Perturbation", "[", 
                    RowBox[{
                    RowBox[{"metric", "[", 
                    RowBox[{
                    RowBox[{"-", "b"}], ",", 
                    RowBox[{"-", "c"}]}], "]"}], ",", 
                    RowBox[{"order", "-", "k", "-", "m"}]}], "]"}]}]}], ",", 
                   RowBox[{"{", 
                    RowBox[{"m", ",", "0", ",", 
                    RowBox[{"order", "-", "k"}]}], "}"}]}], "]"}], ")"}]}], 
               ",", 
               RowBox[{"{", 
                RowBox[{"k", ",", "0", ",", "order"}], "}"}]}], "]"}], 
             ")"}]}], "\[IndentingNewLine]", ")"}], "/", 
          RowBox[{"(", 
           RowBox[{"dimension", "-", "1"}], ")"}]}], "/", 
         RowBox[{"(", 
          RowBox[{"dimension", "-", "2"}], ")"}]}]}]}], "\[IndentingNewLine]",
       "]"}]}], ")"}]}], ";"}]], "Input",
 Evaluatable->False]
}, Closed]]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[StyleBox["5. End private and package",
 FontColor->RGBColor[0, 0, 1]]], "Subsection"],

Cell[BoxData[
 RowBox[{"On", "[", 
  RowBox[{"RuleDelayed", "::", "rhs"}], "]"}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\[IndentingNewLine]", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->True],

Cell[BoxData["\<\"xAct`xPert`Private`\"\>"], "Output"]
}, Open  ]]
}, Closed]]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
WindowSize->{1016, 720},
WindowMargins->{{40, Automatic}, {Automatic, 0}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
ShowSelection->True,
TrackCellChangeTimes->False,
Magnification->1,
FrontEndVersion->"10.2 for Mac OS X x86 (32-bit, 64-bit Kernel) (July 6, \
2015)",
StyleDefinitions->"Default.nb"
]

